<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <style>
        .gantt .bar {
            fill: #FF8200 !important;
            stroke: #FF8200 !important;
        }
        .gantt .bar.external-bar {
            fill: #4B4B4B !important;
            stroke: #4B4B4B !important;
        }
        body {
            margin: 0;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: #4B4B4B;
        }
        .container {
            display: flex;
            height: 100vh;
            gap: 0; /* handle provides its own spacing */
            max-width: 100vw;
            overflow: hidden; /* prevent page horizontal scroll */
        }
        .image-viewer {
            flex: 0 0 auto;
            background: #FF8200;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            border-radius: 24px;
            margin: 2em 0 2em 2em;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            padding: 1.25em 1.5em 1.5em;
            width: 380px;
            min-width: 260px;
            max-width: 720px;
            min-height: calc(100vh - 4em);
            max-height: calc(100vh - 4em);
            box-sizing: border-box;
        }
        .image-viewer h2 { margin: 0 0 0.75em 0; font-size: 1.3em; }
        .image-viewer form { width: 100%; margin-bottom: 0.75em; display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
        #image-viewer-thumbnails { flex:1 1 auto; width:100%; overflow-y:auto; padding:4px; display:flex; flex-wrap:wrap; gap:8px; align-content:flex-start; }
        #image-viewer-thumbnails::-webkit-scrollbar { width: 8px; }
        #image-viewer-thumbnails::-webkit-scrollbar-track { background: rgba(255,255,255,0.15); border-radius:8px; }
        #image-viewer-thumbnails::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.35); border-radius:8px; }
        .thumbnail { width:72px; height:72px; object-fit:cover; border:2px solid #fff; border-radius:10px; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.25); transition:transform .15s; }
        .thumbnail:hover { transform:scale(1.05); }
        #full-image-container { flex:0 0 auto; width:100%; margin-top:0.5em; background:rgba(0,0,0,0.15); border:2px dashed rgba(255,255,255,0.4); border-radius:16px; padding:10px; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:220px; max-height:300px; box-sizing:border-box; }
        #full-image-container.empty { opacity:0.6; }
        #full-image { max-width:100%; max-height:200px; object-fit:contain; }
        #full-image-container button { margin-top:6px; background:#fff; color:#FF8200; border:none; padding:6px 14px; border-radius:20px; font-weight:600; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.25); }
        #full-image-container button:hover { background:#ffe0c2; }
        .planning-section {
            flex: 1 1 auto;
            background: #4B4B4B;
            color: #eee;
            min-width: 0; /* allow flexbox to shrink */
            display:flex;
            flex-direction:column;
            overflow:hidden;
        }
        .planning-scroll {
            flex:1 1 auto;
            overflow-y:auto;
            overflow-x:hidden;
            padding: 0 1.25em 2em 1.25em;
            box-sizing:border-box;
        }
        @media (max-width:1400px){
            #image-viewer-panel{ width:320px !important; }
        }
        @media (max-width:1100px){
            #image-viewer-panel{ display:none; }
            #viewer-resize-handle{ display:none; }
            .planning-section{ border-left: none; }
        }
        .resize-handle {
            flex: 0 0 10px;
            cursor: col-resize;
            position: relative;
            margin: 2em 0;
            width: 10px;
            background: linear-gradient(90deg, rgba(255,130,0,0.15), rgba(255,130,0,0.4), rgba(255,130,0,0.15));
            border-radius: 6px;
            transition: background .2s;
        }
        .resize-handle:before {
            content: '';
            position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            width: 4px; height: 40px; border-radius:2px;
            background: rgba(255,255,255,0.55);
            box-shadow: 0 0 0 1px rgba(0,0,0,0.15);
        }
        .resize-handle:hover { background: linear-gradient(90deg, rgba(255,130,0,0.35), rgba(255,130,0,0.65), rgba(255,130,0,0.35)); }
        .resizing * { user-select: none !important; cursor: col-resize !important; }
        /* ...existing code... */
        .modal-edit {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }
        .modal-edit-content {
            background: #fff;
            padding: 2em;
            border-radius: 16px;
            min-width: 300px;
            max-width: 90vw;
            box-shadow: 0 4px 24px rgba(0,0,0,0.18);
        }
        .modal-edit-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #222;
            font-size: 2em;
            cursor: pointer;
        }
    /* Power T overlay styling inside planning section */
    .planning-section { position:relative; }
    #power-t-logo { position:absolute; top:8px; left:50%; transform:translateX(-50%); height:90%; max-height:95%; width:auto; opacity:0.09; pointer-events:none; z-index:0; }
    .planning-section .planning-scroll { position:relative; z-index:1; }
    @media (max-width:1400px){ #power-t-logo { height:80%; } }
    @media (max-width:1100px){ #power-t-logo { height:70%; } }
    @media (max-width:800px){ #power-t-logo { height:55%; } }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Planning App MVP</title>
    <link rel="stylesheet" href="https://unpkg.com/frappe-gantt@0.5.0/dist/frappe-gantt.css">
    <script src="https://unpkg.com/frappe-gantt@0.5.0/dist/frappe-gantt.min.js"></script>
    <!-- Removed conflicting light mode styles and .darkmode rules -->
</head>
<body>
    <!-- Dark mode is now default, toggle removed; Power T moved inside planning section as overlay -->
    <div class="container">
    <div class="image-viewer" id="image-viewer-panel">
            <h2>Image Viewer</h2>
            <form action="/upload" method="post" enctype="multipart/form-data">
                <input type="file" name="file" accept="image/png, image/jpeg, application/pdf">
                <select name="association-type" required>
                    <option value="">Associate With...</option>
                    <option value="phase">Phase</option>
                    <option value="item">Item</option>
                    <option value="subitem">Sub-Item</option>
                </select>
                <select name="association-id" required>
                    <option value="">Select...</option>
                    {% for phase in phases %}
                        <option value="phase-{{ phase.id }}">Phase: {{ phase.title }}</option>
                    {% endfor %}
                    {% for item in items %}
                        <option value="item-{{ item.id }}">Item: {{ item.title }}</option>
                    {% endfor %}
                    {% for subitem in subitems %}
                        <option value="subitem-{{ subitem.id }}">Sub-Item: {{ subitem.title }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Upload</button>
            </form>
            <div id="image-viewer-thumbnails">
                {% for img in images %}
                    <div style="display:inline-block; position:relative;">
                        <img src="{{ url_for('main.uploaded_file', filename=img.filename) }}" class="thumbnail" title="{{ img.filename }}" onclick="showFullImage(this.src)">
                        {% if not img.phase_id and not img.item_id and not img.subitem_id %}
                        <form action="/delete_image/{{ img.id }}" method="post" style="position:absolute;top:2px;right:2px;">
                            <button type="submit" style="background:#fff;color:#FF8200;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-weight:bold;">&times;</button>
                        </form>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <div id="full-image-container" class="empty">
                <div id="placeholder-text" style="text-align:center;font-size:0.9em;line-height:1.4; padding:0 6px;">Select a thumbnail to preview it here.</div>
                <img id="full-image" src="" style="display:none;">
                <button id="close-full-image" style="display:none;" onclick="hideFullImage()">Close</button>
            </div>
        </div>
    <div id="viewer-resize-handle" class="resize-handle" role="separator" aria-orientation="vertical" aria-label="Resize image viewer" title="Drag to resize (double-click to reset)"></div>
                <div class="planning-section">
                    <img id="power-t-logo" src="{{ url_for('static', filename='Power_T.svg') }}" alt="Power T">
                    <script>
                        document.addEventListener('DOMContentLoaded',function(){
                            var img=document.getElementById('power-t-logo');
                            if(!img) return;
                            let retried=false;
                            img.addEventListener('error',function(){
                                if(!retried){
                                    retried=true;
                                    this.src='/power_t_inline';
                                } else {
                                    this.alt='Power T logo unavailable';
                                }
                            });
                        });
                    </script>
                    <div class="planning-scroll">
            <div style="margin-bottom:2em;display:flex;align-items:center;gap:1em;">
                <label for="project-select" style="font-weight:600;">Project:</label>
                <form id="project-select-form" method="post" action="/set_project" style="display:inline-block;">
                    <select name="project-id" id="project-select" style="min-width:180px;">
                        <option value="">Select Project</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.title }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Go</button>
                </form>
                <form id="project-form" action="/create_project" method="post" style="display:inline-block;">
                    <input type="text" name="project-title" placeholder="New Project Title" required style="min-width:160px;">
                    <button type="submit">Create New Project</button>
                </form>
            </div>
            <h2>Planning Section</h2>
            <div id="planning-view-controls" style="display:flex;gap:1em;align-items:center;margin-bottom:1em;">
                <button onclick="showView('gantt')" id="btn-gantt">Gantt Chart</button>
                <button onclick="showView('calendar')" id="btn-calendar">Calendar</button>
                <button onclick="showView('timeline')" id="btn-timeline">Timeline</button>
            </div>
            <div id="planning-view" style="margin-bottom:2em;">
                <div id="gantt-view" style="display:block;">
                    <h3>Gantt Chart</h3>
                    <div id="gantt-chart" style="height:400px; border:1px solid #888; background:#fff; border-radius:16px;"></div>
                </div>
                <div id="calendar-view" style="display:none;">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <h3 style="margin:0;">Calendar</h3>
                        <a href="/export_calendar_ics" style="background:#FF8200;color:#fff;padding:0.5em 1em;border-radius:8px;text-decoration:none;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:background 0.2s;" onmouseover="this.style.background='#e46e00'" onmouseout="this.style.background='#FF8200'">Export to Outlook</a>
                    </div>
                    <div id="calendar-chart" style="height:400px; border:1px solid #888; background:#fff; border-radius:16px;"></div>
                </div>
                <div id="timeline-view" style="display:none;">
                    <h3>Timeline</h3>
                    <div id="timeline-chart" style="height:400px; border:1px solid #888; background:#fff; border-radius:16px;"></div>
                </div>
            </div>
            <div id="planning-ui" style="background:rgba(255,255,255,0.03);border-radius:16px;padding:1em;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:1em;">
                <div style="display:flex;gap:1em;flex-wrap:wrap;justify-content:space-between;">
                    <form id="phase-form" action="/create_phase" method="post" style="flex:1;min-width:220px;max-width:260px;">
                        <h4 style="margin-top:0;">Add Phase</h4>
                        <input type="text" name="phase-title" placeholder="Phase Title" required>
                        <input type="date" name="phase-start" required>
                        <input type="number" name="phase-duration" placeholder="Duration (days)" required>
                        <label style="display:block;margin-bottom:0.5em;"><input type="checkbox" name="phase-milestone"> Milestone</label>
                        <select name="phase-type">
                            <option value="internal">Internal</option>
                            <option value="external">External</option>
                        </select>
                        <select name="project-id" id="phase-parent-project" required>
                            <option value="">Select Project</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.title }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit">Add</button>
                    </form>
                    <form id="item-form" action="/create_item" method="post" style="flex:1;min-width:220px;max-width:260px;">
                        <h4 style="margin-top:0;">Add Item</h4>
                        <input type="text" name="item-title" placeholder="Item Title" required>
                        <input type="date" name="item-start" required>
                        <input type="number" name="item-duration" placeholder="Duration (days)" required>
                        <input type="text" name="item-dependencies" placeholder="Dependencies (IDs)">
                        <label style="display:block;margin-bottom:0.5em;"><input type="checkbox" name="item-milestone"> Milestone</label>
                        <select name="item-type">
                            <option value="internal">Internal</option>
                            <option value="external">External</option>
                        </select>
                        <select name="phase-id" id="item-parent-phase" required>
                            <option value="">Select Phase</option>
                            {% for phase in phases %}
                            <option value="{{ phase.id }}">{{ phase.title }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit">Add</button>
                    </form>
                    <form id="subitem-form" action="/create_subitem" method="post" style="flex:1;min-width:220px;max-width:260px;">
                        <h4 style="margin-top:0;">Add Sub-Item</h4>
                        <input type="text" name="subitem-title" placeholder="Sub-Item Title" required>
                        <input type="date" name="subitem-start" required>
                        <input type="number" name="subitem-duration" placeholder="Duration (days)" required>
                        <input type="text" name="subitem-dependencies" placeholder="Dependencies (IDs)">
                        <label style="display:block;margin-bottom:0.5em;"><input type="checkbox" name="subitem-milestone"> Milestone</label>
                        <select name="subitem-type">
                            <option value="internal">Internal</option>
                            <option value="external">External</option>
                        </select>
                        <select name="item-id" id="subitem-parent-item" required>
                            <option value="">Select Item</option>
                            {% for item in items %}
                            <option value="{{ item.id }}">{{ item.title }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit">Add</button>
                    </form>
                </div>
                <div id="planning-hierarchy">
                    <h3>Project Hierarchy</h3>
                    <style>
                        .tree-toggle { cursor:pointer; font-weight:600; }
                        .tree-children { margin-left:1em; border-left:2px solid #666; padding-left:0.75em; }
                        .meta { color:#bbb; font-size:0.85em; }
                        .actions a, .actions button { font-size:0.75em; margin-left:0.5em; }
                        .inline-edit { background:rgba(255,255,255,0.05); padding:6px 8px; border-radius:8px; margin:4px 0 8px 18px; }
                        .inline-edit input[type=text], .inline-edit input[type=date], .inline-edit input[type=number], .inline-edit select { font-size:0.75em; padding:2px 4px; margin-right:4px; }
                        .inline-edit button { font-size:0.7em; margin-right:4px; }
                        .node-line button.small { font-size:0.65em; margin-left:6px; }
                        .node-line { display:inline-block; }
                    </style>
                    {% for project in projects %}
                    <div class="project-block" style="margin-bottom:0.75em;">
                        <div class="node-line">
                            <span class="tree-toggle" onclick="toggleNode(this)">[–]</span>
                            <strong>{{ project.title }}</strong>
                            <span class="meta">({{ project.phases|length }} phases)</span>
                            <span class="actions">
                                <a href="/export_project/{{ project.id }}">Export</a>
                                <form method="post" action="/delete_project/{{ project.id }}" style="display:inline;" onsubmit="return confirm('Delete project?');">
                                    <button type="submit" style="color:red;">Del</button>
                                </form>
                                <button type="button" class="small" onclick="toggleEdit('proj-edit-{{ project.id }}')">Edit</button>
                            </span>
                        </div>
                        <div id="proj-edit-{{ project.id }}" class="inline-edit" style="display:none;">
                            <form method="post" action="/edit_project/{{ project.id }}" style="display:flex;flex-wrap:wrap;align-items:center;gap:4px;">
                                <input type="text" name="project-title" value="{{ project.title }}" required>
                                <button type="submit">Save</button>
                                <button type="button" onclick="toggleEdit('proj-edit-{{ project.id }}')">Cancel</button>
                            </form>
                        </div>
                        <div class="tree-children">
                            {% for phase in project.phases %}
                            <div style="margin:4px 0;">
                                <div class="node-line">
                                    <span class="tree-toggle" onclick="toggleNode(this)">[–]</span>
                                    <strong>Phase:</strong> {{ phase.title }} <span class="meta">{{ phase.start_date }} / {{ phase.duration }}d</span>
                                    <span class="actions">
                                        <form method="post" action="/delete_phase/{{ phase.id }}" style="display:inline;" onsubmit="return confirm('Delete phase?');"><button type="submit" style="color:red;">Del</button></form>
                                        <button type="button" class="small" onclick="toggleEdit('phase-edit-{{ phase.id }}')">Edit</button>
                                    </span>
                                </div>
                                <div id="phase-edit-{{ phase.id }}" class="inline-edit" style="display:none;">
                                    <form method="post" action="/edit_phase/{{ phase.id }}" style="display:flex;flex-wrap:wrap;align-items:center;gap:4px;">
                                        <input type="text" name="phase-title" value="{{ phase.title }}" required>
                                        <input type="date" name="phase-start" value="{{ phase.start_date }}" required>
                                        <input type="number" name="phase-duration" value="{{ phase.duration }}" required style="width:70px;">
                                        <label style="font-size:0.65em;">M <input type="checkbox" name="phase-milestone" {% if phase.is_milestone %}checked{% endif %}></label>
                                        <select name="phase-type">
                                            <option value="internal" {% if phase.internal_external=='internal' %}selected{% endif %}>Int</option>
                                            <option value="external" {% if phase.internal_external=='external' %}selected{% endif %}>Ext</option>
                                        </select>
                                        <button type="submit">Save</button>
                                        <button type="button" onclick="toggleEdit('phase-edit-{{ phase.id }}')">Cancel</button>
                                    </form>
                                </div>
                                <div class="tree-children">
                                    {% for item in phase.items %}
                                    <div style="margin:2px 0;">
                                        <div class="node-line">
                                            <span class="tree-toggle" onclick="toggleNode(this)">[–]</span>
                                            <strong>Item:</strong> {{ item.title }} <span class="meta">{{ item.start_date }} / {{ item.duration }}d</span>
                                            <span class="actions">
                                                <form method="post" action="/delete_item/{{ item.id }}" style="display:inline;" onsubmit="return confirm('Delete item?');"><button type="submit" style="color:red;">Del</button></form>
                                                <button type="button" class="small" onclick="toggleEdit('item-edit-{{ item.id }}')">Edit</button>
                                            </span>
                                        </div>
                                        <div id="item-edit-{{ item.id }}" class="inline-edit" style="display:none;">
                                            <form method="post" action="/edit_item/{{ item.id }}" style="display:flex;flex-wrap:wrap;align-items:center;gap:4px;">
                                                <input type="text" name="item-title" value="{{ item.title }}" required>
                                                <input type="date" name="item-start" value="{{ item.start_date }}" required>
                                                <input type="number" name="item-duration" value="{{ item.duration }}" required style="width:70px;">
                                                <input type="text" name="item-dependencies" value="{{ item.dependencies or '' }}" placeholder="Deps" style="width:90px;">
                                                <label style="font-size:0.65em;">M <input type="checkbox" name="item-milestone" {% if item.is_milestone %}checked{% endif %}></label>
                                                <select name="item-type">
                                                    <option value="internal" {% if item.internal_external=='internal' %}selected{% endif %}>Int</option>
                                                    <option value="external" {% if item.internal_external=='external' %}selected{% endif %}>Ext</option>
                                                </select>
                                                <button type="submit">Save</button>
                                                <button type="button" onclick="toggleEdit('item-edit-{{ item.id }}')">Cancel</button>
                                            </form>
                                        </div>
                                        <div class="tree-children">
                                            {% for subitem in item.subitems %}
                                            <div style="margin:2px 0;">
                                                <div class="node-line">
                                                    <strong>Sub:</strong> {{ subitem.title }} <span class="meta">{{ subitem.start_date }} / {{ subitem.duration }}d</span>
                                                    <span class="actions">
                                                        <form method="post" action="/delete_subitem/{{ subitem.id }}" style="display:inline;" onsubmit="return confirm('Delete sub-item?');"><button type="submit" style="color:red;">Del</button></form>
                                                        <button type="button" class="small" onclick="toggleEdit('subitem-edit-{{ subitem.id }}')">Edit</button>
                                                    </span>
                                                </div>
                                                <div id="subitem-edit-{{ subitem.id }}" class="inline-edit" style="display:none;">
                                                    <form method="post" action="/edit_subitem/{{ subitem.id }}" style="display:flex;flex-wrap:wrap;align-items:center;gap:4px;">
                                                        <input type="text" name="subitem-title" value="{{ subitem.title }}" required>
                                                        <input type="date" name="subitem-start" value="{{ subitem.start_date }}" required>
                                                        <input type="number" name="subitem-duration" value="{{ subitem.duration }}" required style="width:70px;">
                                                        <input type="text" name="subitem-dependencies" value="{{ subitem.dependencies or '' }}" placeholder="Deps" style="width:90px;">
                                                        <label style="font-size:0.65em;">M <input type="checkbox" name="subitem-milestone" {% if subitem.is_milestone %}checked{% endif %}></label>
                                                        <select name="subitem-type">
                                                            <option value="internal" {% if subitem.internal_external=='internal' %}selected{% endif %}>Int</option>
                                                            <option value="external" {% if subitem.internal_external=='external' %}selected{% endif %}>Ext</option>
                                                        </select>
                                                        <button type="submit">Save</button>
                                                        <button type="button" onclick="toggleEdit('subitem-edit-{{ subitem.id }}')">Cancel</button>
                                                    </form>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <script>
                    function toggleNode(el){
                        var next=el.parentElement.nextElementSibling; // expects the children container
                        if(!next) return;
                        if(next.style.display==='none'){ next.style.display='block'; el.textContent='[–]'; }
                        else { next.style.display='none'; el.textContent='[+]'; }
                    }
                    function toggleEdit(id){
                        var el = document.getElementById(id);
                        if(!el) return;
                        el.style.display = (el.style.display==='none'|| el.style.display==='') ? 'block':'none';
                    }
                </script>
                <!-- Hidden Gantt data for script parsing -->
                <script id="gantt-data" type="application/json">{{ gantt_json_js|safe }}</script>
                <!-- Removed duplicate Gantt Chart container -->
<script>
function getGanttTasks() {
    try {
        return JSON.parse(document.getElementById('gantt-data').textContent);
    } catch (e) {
        console.error('Error parsing Gantt JSON:', e);
        return [];
    }
}
function renderGantt() {
    var ganttTasks = getGanttTasks();
    console.log('Gantt tasks:', ganttTasks);
    try {
        console.log('Gantt constructor:', typeof Gantt);
    } catch (e) {
        console.error('Gantt not defined:', e);
    }
    if (!ganttTasks || ganttTasks.length === 0) {
        document.getElementById('gantt-chart').innerHTML = '<p style="text-align:center;line-height:400px;">No tasks to display</p>';
        return;
    }
    if (typeof Gantt !== 'function') {
        document.getElementById('gantt-chart').innerHTML = '<p style="color:red;text-align:center;">Gantt library not loaded</p>';
        return;
    }
    var gantt = new Gantt("#gantt-chart", ganttTasks, {
        view_mode: 'Day',
        custom_popup_html: null,
        on_date_change: function(task, start, end) {
            // Send AJAX request to update start/end in backend
            fetch('/update_gantt_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: task.id,
                    start: start.toISOString().slice(0,10),
                    end: end.toISOString().slice(0,10)
                })
            }).then(res => {
                if(res.ok) {
                    alert('Task updated!');
                } else {
                    alert('Error updating task.');
                }
            });
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {
    renderGantt();
});
/* Removed incomplete window.showView assignment to fix syntax error */
</script>
                    </div>
                    <div id="calendar-view" style="display:none;">
                            <h3>Calendar View</h3>
                            <div id="calendar-chart" style="height:400px;"></div>
                            <div id="calendar-empty-message" style="display:none;text-align:center;line-height:400px;color:#888;font-size:1.2em;">No events to display</div>
                                                <!-- Edit Event Modal -->
                                                <div class="modal fade" id="editEventModal" tabindex="-1" role="dialog" aria-labelledby="editEventModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog" role="document">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="editEventModalLabel">Edit Event</h5>
                                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                    <span aria-hidden="true">&times;</span>
                                                                </button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <form id="editEventForm">
                                                                    <div class="form-group">
                                                                        <label for="eventTitle">Title</label>
                                                                        <input type="text" class="form-control" id="eventTitle" name="eventTitle">
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label for="eventStart">Start Date</label>
                                                                        <input type="date" class="form-control" id="eventStart" name="eventStart">
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label for="eventEnd">End Date</label>
                                                                        <input type="date" class="form-control" id="eventEnd" name="eventEnd">
                                                                    </div>
                                                                    <input type="hidden" id="eventId" name="eventId">
                                                                </form>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                                <button type="button" class="btn btn-primary" id="saveEventBtn">Save changes</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css">
                                                <style>
                                                /* Darken FullCalendar grid and text */
                                                .fc .fc-col-header-cell, .fc .fc-daygrid-day-number, .fc .fc-daygrid-day {
                                                    color: #222 !important;
                                                }
                                                .fc .fc-daygrid-day-frame {
                                                    background: #fff !important;
                                                    border-color: #bbb !important;
                                                }
                                                .fc .fc-scrollgrid, .fc .fc-scrollgrid-section {
                                                    border-color: #888 !important;
                                                }
                                                .fc .fc-toolbar-title {
                                                    color: #222 !important;
                                                }
                                                </style>
                                                <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
                                                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                                                <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
                                                <script>
                                                var calendarEvents = JSON.parse('{{ calendar_events_json|safe }}').map(function(e){
                                                    // Ensure each event has an id for reliable editing
                                                    if(!e.id){
                                                        if(e.title.startsWith('Phase: ')) e.id = 'phase-' + e.title.replace('Phase: ','').replace(/\s+/g,'-');
                                                        else if(e.title.startsWith('Item: ')) e.id = 'item-' + e.title.replace('Item: ','').replace(/\s+/g,'-');
                                                        else e.id = 'evt-' + btoa(e.title).replace(/=/g,'');
                                                    }
                                                    return e;
                                                });
                                                document.addEventListener('DOMContentLoaded', function() {
                                                        var calendarEl = document.getElementById('calendar-chart');
                                                        if (!calendarEl) return;
                                                        window._calendarInstance = new FullCalendar.Calendar(calendarEl, {
                                                                initialView: 'dayGridMonth',
                                                                selectable: true,
                                                                editable: true,
                                                                height: 420,
                                                                events: calendarEvents,
                                                                select: function(selInfo){
                                                                    // Prefill modal for new event
                                                                    document.getElementById('eventTitle').value = '';
                                                                    document.getElementById('eventStart').value = selInfo.startStr.slice(0,10);
                                                                    // FullCalendar's exclusive end for allDay selection: subtract one day if provided
                                                                    var endStr = selInfo.end ? new Date(selInfo.end.getTime()-86400000).toISOString().slice(0,10) : selInfo.startStr.slice(0,10);
                                                                    document.getElementById('eventEnd').value = endStr;
                                                                    document.getElementById('eventId').value = '';
                                                                    window.currentCalendarEvent = null; // indicates new
                                                                    $('#editEventModal').modal('show');
                                                                },
                                                                eventClick: function(info) {
                                                                    var event = info.event;
                                                                    document.getElementById('eventTitle').value = event.title;
                                                                    document.getElementById('eventStart').value = event.startStr.slice(0,10);
                                                                    document.getElementById('eventEnd').value = event.endStr ? event.endStr.slice(0,10) : event.startStr.slice(0,10);
                                                                    if (event.id) {
                                                                        document.getElementById('eventId').value = event.id;
                                                                    } else {
                                                                        if (event.title.startsWith('Phase: ')) {
                                                                            document.getElementById('eventId').value = 'phase-' + event.title.replace('Phase: ', '').split(' ')[0];
                                                                        } else if (event.title.startsWith('Item: ')) {
                                                                            document.getElementById('eventId').value = 'item-' + event.title.replace('Item: ', '').split(' ')[0];
                                                                        } else {
                                                                            document.getElementById('eventId').value = event.title;
                                                                        }
                                                                    }
                                                                    $('#editEventModal').modal('show');
                                                                    window.currentCalendarEvent = event;
                                                                },
                                                                eventDrop: function(info) {
                                                                    var event = info.event;
                                                                    var id = document.getElementById('eventId').value || event.id || event.title;
                                                                    fetch('/update_gantt_task', {
                                                                        method: 'POST',
                                                                        headers: {
                                                                            'Content-Type': 'application/json'
                                                                        },
                                                                        body: JSON.stringify({
                                                                            id: id,
                                                                            start: event.startStr,
                                                                            end: event.endStr || event.startStr
                                                                        })
                                                                    }).then(function(res) {
                                                                        if(res.ok) {
                                                                            location.reload();
                                                                        } else {
                                                                            alert('Error updating event.');
                                                                        }
                                                                    });
                                                                },
                                                                eventResize: function(info){
                                                                    var event = info.event;
                                                                    var id = event.id;
                                                                    fetch('/update_gantt_task', {
                                                                        method: 'POST',
                                                                        headers: { 'Content-Type': 'application/json' },
                                                                        body: JSON.stringify({
                                                                            id: id,
                                                                            start: event.startStr,
                                                                            end: event.endStr || event.startStr
                                                                        })
                                                                    }).then(r=>{ if(!r.ok) alert('Resize failed'); });
                                                                }
                                                            });
                                                        // Show empty message if no events
                                                        if(calendarEvents.length === 0) {
                                                            document.getElementById('calendar-chart').style.display = 'none';
                                                            var emptyMsg = document.getElementById('calendar-empty-message');
                                                            if (emptyMsg) emptyMsg.style.display = 'block';
                                                        } else {
                                                            window._calendarInstance.render();
                                                        }
                                                        document.getElementById('saveEventBtn').onclick = function() {
                                                            var event = window.currentCalendarEvent;
                                                            var newTitle = document.getElementById('eventTitle').value;
                                                            var newStart = document.getElementById('eventStart').value;
                                                            var newEnd = document.getElementById('eventEnd').value || newStart;
                                                            if(event){
                                                                var id = event.id;
                                                                // Update existing
                                                                event.setProp('title', newTitle);
                                                                event.setStart(newStart);
                                                                event.setEnd(newEnd);
                                                                fetch('/update_gantt_task', {
                                                                    method: 'POST',
                                                                    headers: { 'Content-Type': 'application/json' },
                                                                    body: JSON.stringify({ id: id, start: newStart, end: newEnd, title:newTitle })
                                                                }).then(res => { if(!res.ok) alert('Error updating event'); else $('#editEventModal').modal('hide'); });
                                                            } else {
                                                                // Create a new ad-hoc event only in UI (not persisted if no id pattern)
                                                                var tempId = newTitle.startsWith('Phase: ')? 'phase-' + newTitle.replace('Phase: ','').replace(/\s+/g,'-') : newTitle.startsWith('Item: ')? 'item-' + newTitle.replace('Item: ','').replace(/\s+/g,'-') : 'evt-' + Date.now();
                                                                window._calendarInstance.addEvent({ id: tempId, title:newTitle, start:newStart, end:newEnd, color: newTitle.startsWith('Phase: ')? '#FF8200':'#4B4B4B' });
                                                                $('#editEventModal').modal('hide');
                                                            }
                                                            document.getElementById('eventId').value='';
                                                            window.currentCalendarEvent=null;
                            };
                        }); // Close DOMContentLoaded listener
                </script>
            </div>
                    </div>
                </div>
    </div>
    <div id="image-modal" class="modal" onclick="closeModal(event)">
    <!-- Modal removed: images now display in viewer section -->
    <div id="modal-edit" class="modal-edit" onclick="closeEditModal(event)">
        <span class="modal-edit-close" onclick="closeEditModal(event)">&times;</span>
        <div class="modal-edit-content" id="modal-edit-content">
            <!-- Modal form will be injected here -->
        </div>
    </div>
    <script>
        function toggleDarkMode() {
            document.body.classList.toggle('darkmode');
        }
        function showView(view) {
            document.getElementById('gantt-view').style.display = 'none';
            document.getElementById('calendar-view').style.display = 'none';
            document.getElementById('timeline-view').style.display = 'none';
            if(view === 'gantt') document.getElementById('gantt-view').style.display = 'block';
            if(view === 'calendar') document.getElementById('calendar-view').style.display = 'block';
            if(view === 'timeline') document.getElementById('timeline-view').style.display = 'block';
        }
        // Image viewer logic
        function showFullImage(src) {
            const cont = document.getElementById('full-image-container');
            const img = document.getElementById('full-image');
            const ph = document.getElementById('placeholder-text');
            const closeBtn = document.getElementById('close-full-image');
            img.src = src;
            img.style.display = 'block';
            closeBtn.style.display = 'inline-block';
            if (ph) ph.style.display = 'none';
            cont.classList.remove('empty');
        }
        function hideFullImage() {
            const cont = document.getElementById('full-image-container');
            const img = document.getElementById('full-image');
            const ph = document.getElementById('placeholder-text');
            const closeBtn = document.getElementById('close-full-image');
            img.src = '';
            img.style.display = 'none';
            closeBtn.style.display = 'none';
            if (ph) ph.style.display = 'block';
            cont.classList.add('empty');
        }
        // --- Image viewer resize logic ---
        (function(){
            const panel = document.getElementById('image-viewer-panel');
            const handle = document.getElementById('viewer-resize-handle');
            if(!panel || !handle) return;
            let startX = 0; let startW = 0; let dragging = false;
            const MIN_W = 260; const MAX_W = 720; const DEFAULT_W = 380;
            function pxToNum(v){ return parseFloat(String(v).replace('px','')) || 0; }
            function onMouseMove(e){
                if(!dragging) return;
                const dx = e.clientX - startX;
                let w = Math.min(MAX_W, Math.max(MIN_W, startW + dx));
                panel.style.width = w + 'px';
            }
            function stop(){
                if(!dragging) return;
                dragging = false;
                document.documentElement.classList.remove('resizing');
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', stop);
            }
            handle.addEventListener('mousedown', e=>{
                startX = e.clientX;
                startW = panel.getBoundingClientRect().width;
                dragging = true;
                document.documentElement.classList.add('resizing');
                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('mouseup', stop);
                e.preventDefault();
            });
            handle.addEventListener('dblclick', ()=>{ panel.style.width = DEFAULT_W + 'px'; });
            // Touch support
            handle.addEventListener('touchstart', e=>{
                const t = e.touches[0];
                startX = t.clientX; startW = panel.getBoundingClientRect().width; dragging = true;
                document.documentElement.classList.add('resizing');
                window.addEventListener('touchmove', onTouchMove, {passive:false});
                window.addEventListener('touchend', stopTouch, {passive:false});
            }, {passive:false});
            function onTouchMove(e){
                if(!dragging) return; const t = e.touches[0];
                const dx = t.clientX - startX; let w = Math.min(MAX_W, Math.max(MIN_W, startW + dx));
                panel.style.width = w + 'px'; e.preventDefault();
            }
            function stopTouch(){ dragging=false; document.documentElement.classList.remove('resizing'); window.removeEventListener('touchmove', onTouchMove); window.removeEventListener('touchend', stopTouch); }
        })();
        function openEditModal(type, id, title, start, duration, milestone, internal_external, dependencies) {
            event.stopPropagation();
            let formHtml = '';
            if(type === 'project') {
                formHtml = `<form method='post' action='/edit_project/${id}'>
                    <h3>Edit Project</h3>
                    <input type='text' name='project-title' value='${title}' required><br>
                    <button type='submit'>Save</button>
                </form>`;
            } else if(type === 'phase') {
                formHtml = `<form method='post' action='/edit_phase/${id}'>
                    <h3>Edit Phase</h3>
                    <input type='text' name='phase-title' value='${title}' required><br>
                    <input type='date' name='phase-start' value='${start}' required><br>
                    <input type='number' name='phase-duration' value='${duration}' required><br>
                    <label><input type='checkbox' name='phase-milestone' ${milestone==='true'?'checked':''}> Milestone</label><br>
                    <select name='phase-type'>
                        <option value='internal' ${internal_external==='internal'?'selected':''}>Internal</option>
                        <option value='external' ${internal_external==='external'?'selected':''}>External</option>
                    </select><br>
                    <button type='submit'>Save</button>
                </form>`;
            } else if(type === 'item') {
                formHtml = `<form method='post' action='/edit_item/${id}'>
                    <h3>Edit Item</h3>
                    <input type='text' name='item-title' value='${title}' required><br>
                    <input type='date' name='item-start' value='${start}' required><br>
                    <input type='number' name='item-duration' value='${duration}' required><br>
                    <input type='text' name='item-dependencies' value='${dependencies||''}'><br>
                    <label><input type='checkbox' name='item-milestone' ${milestone==='true'?'checked':''}> Milestone</label><br>
                    <select name='item-type'>
                        <option value='internal' ${internal_external==='internal'?'selected':''}>Internal</option>
                        <option value='external' ${internal_external==='external'?'selected':''}>External</option>
                    </select><br>
                    <button type='submit'>Save</button>
                </form>`;
            } else if(type === 'subitem') {
                formHtml = `<form method='post' action='/edit_subitem/${id}'>
                    <h3>Edit Sub-Item</h3>
                    <input type='text' name='subitem-title' value='${title}' required><br>
                    <input type='date' name='subitem-start' value='${start}' required><br>
                    <input type='number' name='subitem-duration' value='${duration}' required><br>
                    <input type='text' name='subitem-dependencies' value='${dependencies||''}'><br>
                    <label><input type='checkbox' name='subitem-milestone' ${milestone==='true'?'checked':''}> Milestone</label><br>
                    <select name='subitem-type'>
                        <option value='internal' ${internal_external==='internal'?'selected':''}>Internal</option>
                        <option value='external' ${internal_external==='external'?'selected':''}>External</option>
                    </select><br>
                    <button type='submit'>Save</button>
                </form>`;
            }
            document.getElementById('modal-edit-content').innerHTML = formHtml;
            document.getElementById('modal-edit').style.display = 'flex';
    }
    function closeEditModal(event) {
            if(event.target.classList.contains('modal-edit') || event.target.classList.contains('modal-edit-close')) {
                document.getElementById('modal-edit').style.display = 'none';
                document.getElementById('modal-edit-content').innerHTML = '';
            }
        }
    </script>
</body>
</html>
