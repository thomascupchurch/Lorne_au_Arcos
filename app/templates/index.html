<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <style>
        .gantt .bar {
            fill: #FF8200 !important;
            stroke: #FF8200 !important;
        }
        .gantt .bar.external-bar {
            fill: #4B4B4B !important;
            stroke: #4B4B4B !important;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Planning App MVP</title>
    <link rel="stylesheet" href="https://unpkg.com/frappe-gantt@0.5.0/dist/frappe-gantt.css">
    <script src="https://unpkg.com/frappe-gantt@0.5.0/dist/frappe-gantt.min.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        .container { display: flex; height: 100vh; }
        .image-viewer { flex: 1; background: #222; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .planning-section { flex: 2; background: #f4f4f4; color: #222; padding: 2em; overflow-y: auto; }
        .darkmode .image-viewer { background: #111; }
        .darkmode .planning-section { background: #222; color: #eee; }
        .toggle-dark { position: absolute; top: 10px; right: 10px; }
        .thumbnail { width: 80px; height: 80px; object-fit: cover; margin: 5px; cursor: pointer; border: 2px solid #ccc; }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8); align-items: center; justify-content: center;
        }
        .modal-content {
            max-width: 90vw; max-height: 90vh; display: block; margin: auto; border-radius: 8px;
        }
        .modal-close {
            position: absolute; top: 20px; right: 40px; color: #fff; font-size: 2em; cursor: pointer;
        }
        .modal-edit {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7); align-items: center; justify-content: center;
        }
        .modal-edit-content {
            background: #fff; padding: 2em; border-radius: 8px; min-width: 300px; max-width: 90vw;
        }
        .modal-edit-close {
            position: absolute; top: 20px; right: 40px; color: #222; font-size: 2em; cursor: pointer;
        }
    </style>
</head>
<body>
    <button class="toggle-dark" onclick="toggleDarkMode()">Toggle Dark Mode</button>
    <div class="container">
        <div class="image-viewer">
            <h2>Image Viewer</h2>
            <form action="/upload" method="post" enctype="multipart/form-data">
                <input type="file" name="file" accept="image/png, image/jpeg, application/pdf">
                <select name="association-type" required>
                    <option value="">Associate With...</option>
                    <option value="phase">Phase</option>
                    <option value="item">Item</option>
                    <option value="subitem">Sub-Item</option>
                </select>
                <select name="association-id" required>
                    <option value="">Select...</option>
                    {% for phase in phases %}
                        <option value="phase-{{ phase.id }}">Phase: {{ phase.title }}</option>
                    {% endfor %}
                    {% for item in items %}
                        <option value="item-{{ item.id }}">Item: {{ item.title }}</option>
                    {% endfor %}
                    {% for subitem in subitems %}
                        <option value="subitem-{{ subitem.id }}">Sub-Item: {{ subitem.title }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Upload</button>
            </form>
            <div id="thumbnails"></div>
        </div>
        <div class="planning-section">
            <h2>Planning Section</h2>
            <div>
                <button onclick="showView('gantt')">Gantt Chart</button>
                <button onclick="showView('calendar')">Calendar</button>
                <button onclick="showView('timeline')">Timeline</button>
            </div>
            <div id="planning-ui">
                <form id="project-form" action="/create_project" method="post">
                    <h3>Create Project</h3>
                    <input type="text" name="project-title" placeholder="Project Title" required>
                    <button type="submit">Add Project</button>
                </form>
                <form id="phase-form" action="/create_phase" method="post">
                    <h3>Add Phase</h3>
                    <input type="text" name="phase-title" placeholder="Phase Title" required>
                    <input type="date" name="phase-start" required>
                    <input type="number" name="phase-duration" placeholder="Duration (days)" required>
                    <label><input type="checkbox" name="phase-milestone"> Milestone</label>
                    <select name="phase-type">
                        <option value="internal">Internal</option>
                        <option value="external">External</option>
                    </select>
                    <select name="project-id" id="phase-parent-project" required>
                        <option value="">Select Project</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.title }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Add Phase</button>
                </form>
                <form id="item-form" action="/create_item" method="post">
                    <h3>Add Item</h3>
                    <input type="text" name="item-title" placeholder="Item Title" required>
                    <input type="date" name="item-start" required>
                    <input type="number" name="item-duration" placeholder="Duration (days)" required>
                    <input type="text" name="item-dependencies" placeholder="Dependencies (IDs)">
                    <label><input type="checkbox" name="item-milestone"> Milestone</label>
                    <select name="item-type">
                        <option value="internal">Internal</option>
                        <option value="external">External</option>
                    </select>
                    <select name="phase-id" id="item-parent-phase" required>
                        <option value="">Select Phase</option>
                        {% for phase in phases %}
                        <option value="{{ phase.id }}">{{ phase.title }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Add Item</button>
                </form>
                <form id="subitem-form" action="/create_subitem" method="post">
                    <h3>Add Sub-Item</h3>
                    <input type="text" name="subitem-title" placeholder="Sub-Item Title" required>
                    <input type="date" name="subitem-start" required>
                    <input type="number" name="subitem-duration" placeholder="Duration (days)" required>
                    <input type="text" name="subitem-dependencies" placeholder="Dependencies (IDs)">
                    <label><input type="checkbox" name="subitem-milestone"> Milestone</label>
                    <select name="subitem-type">
                        <option value="internal">Internal</option>
                        <option value="external">External</option>
                    </select>
                    <select name="item-id" id="subitem-parent-item" required>
                        <option value="">Select Item</option>
                        {% for item in items %}
                        <option value="{{ item.id }}">{{ item.title }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Add Sub-Item</button>
                </form>
                <div id="planning-hierarchy">
                    <h3>Project Hierarchy</h3>
                    {% for project in projects %}
                        <div><strong>Project:</strong> {{ project.title }}
                            <a href="/export_project/{{ project.id }}" style="margin-left:1em;">Export</a>
                            <form method="post" action="/edit_project/{{ project.id }}">
                                <input type="text" name="project-title" value="{{ project.title }}" required>
                                <button type="submit">Edit</button>
                            </form>
                            <form method="post" action="/delete_project/{{ project.id }}" onsubmit="return confirm('Delete this project and all its contents?');">
                                <button type="submit" style="color:red;">Delete</button>
                            </form>
                            <ul>
                            {% for phase in project.phases %}
                                <li><strong>Phase:</strong> {{ phase.title }}
                                    <form method="post" action="/edit_phase/{{ phase.id }}">
                                        <input type="text" name="phase-title" value="{{ phase.title }}" required>
                                        <input type="date" name="phase-start" value="{{ phase.start_date }}" required>
                                        <input type="number" name="phase-duration" value="{{ phase.duration }}" required>
                                        <label><input type="checkbox" name="phase-milestone" {% if phase.is_milestone %}checked{% endif %}> Milestone</label>
                                        <select name="phase-type">
                                            <option value="internal" {% if phase.internal_external == 'internal' %}selected{% endif %}>Internal</option>
                                            <option value="external" {% if phase.internal_external == 'external' %}selected{% endif %}>External</option>
                                        </select>
                                        <button type="submit">Edit</button>
                                    </form>
                                    <form method="post" action="/delete_phase/{{ phase.id }}" onsubmit="return confirm('Delete this phase and all its items?');">
                                        <button type="submit" style="color:red;">Delete</button>
                                    </form>
                                    {% if phase.images %}
                                        <div>
                                            {% for img in phase.images %}
                                                <span style="display:inline-block;position:relative;">
                                                    <img src="{{ url_for('main.uploaded_file', filename=img.filename) }}" class="thumbnail" title="{{ img.filename }}">
                                                    <form method="post" action="/delete_image/{{ img.id }}" style="position:absolute;top:0;right:0;">
                                                        <button type="submit" style="background:red;color:white;border:none;padding:2px 6px;font-size:10px;cursor:pointer;">&times;</button>
                                                    </form>
                                                </span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <ul>
                                    {% for item in phase.items %}
                                        <li><strong>Item:</strong> {{ item.title }}
                                            <form method="post" action="/edit_item/{{ item.id }}">
                                                <input type="text" name="item-title" value="{{ item.title }}" required>
                                                <input type="date" name="item-start" value="{{ item.start_date }}" required>
                                                <input type="number" name="item-duration" value="{{ item.duration }}" required>
                                                <input type="text" name="item-dependencies" value="{{ item.dependencies }}">
                                                <label><input type="checkbox" name="item-milestone" {% if item.is_milestone %}checked{% endif %}> Milestone</label>
                                                <select name="item-type">
                                                    <option value="internal" {% if item.internal_external == 'internal' %}selected{% endif %}>Internal</option>
                                                    <option value="external" {% if item.internal_external == 'external' %}selected{% endif %}>External</option>
                                                </select>
                                                <button type="submit">Edit</button>
                                            </form>
                                            <form method="post" action="/delete_item/{{ item.id }}" onsubmit="return confirm('Delete this item and all its sub-items?');">
                                                <button type="submit" style="color:red;">Delete</button>
                                            </form>
                                            {% if item.images %}
                                                <div>
                                                    {% for img in item.images %}
                                                        <span style="display:inline-block;position:relative;">
                                                            <img src="{{ url_for('main.uploaded_file', filename=img.filename) }}" class="thumbnail" title="{{ img.filename }}">
                                                            <form method="post" action="/delete_image/{{ img.id }}" style="position:absolute;top:0;right:0;">
                                                                <button type="submit" style="background:red;color:white;border:none;padding:2px 6px;font-size:10px;cursor:pointer;">&times;</button>
                                                            </form>
                                                        </span>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                            <ul>
                                            {% for subitem in item.subitems %}
                                                <li><strong>Sub-Item:</strong> {{ subitem.title }}
                                                    <form method="post" action="/edit_subitem/{{ subitem.id }}">
                                                        <input type="text" name="subitem-title" value="{{ subitem.title }}" required>
                                                        <input type="date" name="subitem-start" value="{{ subitem.start_date }}" required>
                                                        <input type="number" name="subitem-duration" value="{{ subitem.duration }}" required>
                                                        <input type="text" name="subitem-dependencies" value="{{ subitem.dependencies }}">
                                                        <label><input type="checkbox" name="subitem-milestone" {% if subitem.is_milestone %}checked{% endif %}> Milestone</label>
                                                        <select name="subitem-type">
                                                            <option value="internal" {% if subitem.internal_external == 'internal' %}selected{% endif %}>Internal</option>
                                                            <option value="external" {% if subitem.internal_external == 'external' %}selected{% endif %}>External</option>
                                                        </select>
                                                        <button type="submit">Edit</button>
                                                    </form>
                                                    <form method="post" action="/delete_subitem/{{ subitem.id }}" onsubmit="return confirm('Delete this sub-item?');">
                                                        <button type="submit" style="color:red;">Delete</button>
                                                    </form>
                                                    {% if subitem.images %}
                                                        <div>
                                                            {% for img in subitem.images %}
                                                                <span style="display:inline-block;position:relative;">
                                                                    <img src="{{ url_for('main.uploaded_file', filename=img.filename) }}" class="thumbnail" title="{{ img.filename }}">
                                                                    <form method="post" action="/delete_image/{{ img.id }}" style="position:absolute;top:0;right:0;">
                                                                        <button type="submit" style="background:red;color:white;border:none;padding:2px 6px;font-size:10px;cursor:pointer;">&times;</button>
                                                                    </form>
                                                                </span>
                                                            {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                </li>
                                            {% endfor %}
                                            </ul>
                                        </li>
                                    {% endfor %}
                                    </ul>
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                    {% endfor %}
                </div>
                <div id="planning-view">
                    <div id="gantt-view" style="display:block;">
                        <h3>Gantt Chart</h3>
                        <div id="gantt-chart" style="height:400px; border:1px solid #888; background:#fff;"></div>
                    </div>
<script>
var ganttTasks = JSON.parse('{{ gantt_json_js|safe }}');
function renderGantt() {
    console.log('Gantt tasks:', ganttTasks);
    try {
        console.log('Gantt constructor:', typeof Gantt);
    } catch (e) {
        console.error('Gantt not defined:', e);
    }
    if (!ganttTasks || ganttTasks.length === 0) {
        document.getElementById('gantt-chart').innerHTML = '<p style="text-align:center;line-height:400px;">No tasks to display</p>';
        return;
    }
    if (typeof Gantt !== 'function') {
        document.getElementById('gantt-chart').innerHTML = '<p style="color:red;text-align:center;">Gantt library not loaded</p>';
        return;
    }
    var gantt = new Gantt("#gantt-chart", ganttTasks, {
        view_mode: 'Day',
        custom_popup_html: null,
        on_date_change: function(task, start, end) {
            // Send AJAX request to update start/end in backend
            fetch('/update_gantt_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: task.id,
                    start: start.toISOString().slice(0,10),
                    end: end.toISOString().slice(0,10)
                })
            }).then(res => {
                if(res.ok) {
                    location.reload();
                } else {
                    alert('Error updating task.');
                }
            });
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {
    renderGantt();
});
</script>
<script>
function getGanttTasks() {
    try {
        return JSON.parse(document.getElementById('gantt-data').textContent);
    } catch (e) {
        console.error('Error parsing Gantt JSON:', e);
        return [];
    }
}
function renderGantt() {
    var ganttTasks = getGanttTasks();
    console.log('Gantt tasks:', ganttTasks);
    try {
        console.log('Gantt constructor:', typeof Gantt);
    } catch (e) {
        console.error('Gantt not defined:', e);
    }
    if (!ganttTasks || ganttTasks.length === 0) {
        document.getElementById('gantt-chart').innerHTML = '<p style="text-align:center;line-height:400px;">No tasks to display</p>';
        return;
    }
    if (typeof Gantt !== 'function') {
        document.getElementById('gantt-chart').innerHTML = '<p style="color:red;text-align:center;">Gantt library not loaded</p>';
        return;
    }
    var gantt = new Gantt("#gantt-chart", ganttTasks, {
        view_mode: 'Day',
        custom_popup_html: null,
        on_date_change: function(task, start, end) {
            // Send AJAX request to update start/end in backend
            fetch('/update_gantt_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: task.id,
                    start: start.toISOString().slice(0,10),
                    end: end.toISOString().slice(0,10)
                })
            }).then(res => {
                if(res.ok) {
                    alert('Task updated!');
                } else {
                    alert('Error updating task.');
                }
            });
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {
    renderGantt();
});
window.showView = (function(orig){
    // Gantt view is always default; toggling is disabled for now
</script>
                    </div>
                    <div id="calendar-view" style="display:none;">
                        <h3>Calendar View (Placeholder)</h3>
                        <p>Calendar will be rendered here.</p>
                    </div>
                    <div id="timeline-view" style="display:none;">
                        <h3>Timeline View (Placeholder)</h3>
                        <p>Timeline will be rendered here.</p>
                    </div>
                </div>
                <script>
        // Persist last used parent for phase, item, and subitem creation
        document.addEventListener('DOMContentLoaded', function() {
            // Phase form: project parent
            const phaseParent = document.getElementById('phase-parent-project');
            if (phaseParent) {
                const lastProject = localStorage.getItem('lastProjectId');
                if (lastProject) phaseParent.value = lastProject;
                phaseParent.addEventListener('change', function() {
                    localStorage.setItem('lastProjectId', phaseParent.value);
                });
            }
            // Item form: phase parent
            const itemParent = document.getElementById('item-parent-phase');
            if (itemParent) {
                const lastPhase = localStorage.getItem('lastPhaseId');
                if (lastPhase) itemParent.value = lastPhase;
                itemParent.addEventListener('change', function() {
                    localStorage.setItem('lastPhaseId', itemParent.value);
                });
            }
            // Subitem form: item parent
            const subitemParent = document.getElementById('subitem-parent-item');
            if (subitemParent) {
                const lastItem = localStorage.getItem('lastItemId');
                if (lastItem) subitemParent.value = lastItem;
                subitemParent.addEventListener('change', function() {
                    localStorage.setItem('lastItemId', subitemParent.value);
                });
            }
        });
                    function showView(view) {
                        document.getElementById('gantt-view').style.display = 'none';
                        document.getElementById('calendar-view').style.display = 'none';
                        document.getElementById('timeline-view').style.display = 'none';
                        if(view === 'gantt') document.getElementById('gantt-view').style.display = 'block';
                        if(view === 'calendar') document.getElementById('calendar-view').style.display = 'block';
                        if(view === 'timeline') document.getElementById('timeline-view').style.display = 'block';
                    }
                </script>
            </div>
        </div>
    </div>
    <div id="image-modal" class="modal" onclick="closeModal(event)">
        <span class="modal-close" onclick="closeModal(event)">&times;</span>
        <img id="modal-img" class="modal-content" src="" alt="Full Size Image">
    </div>
    <div id="modal-edit" class="modal-edit" onclick="closeEditModal(event)">
        <span class="modal-edit-close" onclick="closeEditModal(event)">&times;</span>
        <div class="modal-edit-content" id="modal-edit-content">
            <!-- Modal form will be injected here -->
        </div>
    </div>
    <script>
        function toggleDarkMode() {
            document.body.classList.toggle('darkmode');
        }
        function showView(view) {
            document.getElementById('gantt-view').style.display = 'none';
            document.getElementById('calendar-view').style.display = 'none';
            document.getElementById('timeline-view').style.display = 'none';
            if(view === 'gantt') document.getElementById('gantt-view').style.display = 'block';
            if(view === 'calendar') document.getElementById('calendar-view').style.display = 'block';
            if(view === 'timeline') document.getElementById('timeline-view').style.display = 'block';
        }
        // Modal logic for thumbnails
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.thumbnail').forEach(function(img) {
                img.addEventListener('click', function(e) {
                    e.stopPropagation();
                    document.getElementById('modal-img').src = img.src;
                    document.getElementById('image-modal').style.display = 'flex';
                });
            });
        });
        function closeModal(event) {
            if(event.target.classList.contains('modal') || event.target.classList.contains('modal-close')) {
                document.getElementById('image-modal').style.display = 'none';
                document.getElementById('modal-img').src = '';
            }
        }
        function openEditModal(type, id, title, start, duration, milestone, internal_external, dependencies) {
            event.stopPropagation();
            let formHtml = '';
            if(type === 'project') {
                formHtml = `<form method='post' action='/edit_project/${id}'>
                    <h3>Edit Project</h3>
                    <input type='text' name='project-title' value='${title}' required><br>
                    <button type='submit'>Save</button>
                </form>`;
            } else if(type === 'phase') {
                formHtml = `<form method='post' action='/edit_phase/${id}'>
                    <h3>Edit Phase</h3>
                    <input type='text' name='phase-title' value='${title}' required><br>
                    <input type='date' name='phase-start' value='${start}' required><br>
                    <input type='number' name='phase-duration' value='${duration}' required><br>
                    <label><input type='checkbox' name='phase-milestone' ${milestone==='true'?'checked':''}> Milestone</label><br>
                    <select name='phase-type'>
                        <option value='internal' ${internal_external==='internal'?'selected':''}>Internal</option>
                        <option value='external' ${internal_external==='external'?'selected':''}>External</option>
                    </select><br>
                    <button type='submit'>Save</button>
                </form>`;
            } else if(type === 'item') {
                formHtml = `<form method='post' action='/edit_item/${id}'>
                    <h3>Edit Item</h3>
                    <input type='text' name='item-title' value='${title}' required><br>
                    <input type='date' name='item-start' value='${start}' required><br>
                    <input type='number' name='item-duration' value='${duration}' required><br>
                    <input type='text' name='item-dependencies' value='${dependencies||''}'><br>
                    <label><input type='checkbox' name='item-milestone' ${milestone==='true'?'checked':''}> Milestone</label><br>
                    <select name='item-type'>
                        <option value='internal' ${internal_external==='internal'?'selected':''}>Internal</option>
                        <option value='external' ${internal_external==='external'?'selected':''}>External</option>
                    </select><br>
                    <button type='submit'>Save</button>
                </form>`;
            } else if(type === 'subitem') {
                formHtml = `<form method='post' action='/edit_subitem/${id}'>
                    <h3>Edit Sub-Item</h3>
                    <input type='text' name='subitem-title' value='${title}' required><br>
                    <input type='date' name='subitem-start' value='${start}' required><br>
                    <input type='number' name='subitem-duration' value='${duration}' required><br>
                    <input type='text' name='subitem-dependencies' value='${dependencies||''}'><br>
                    <label><input type='checkbox' name='subitem-milestone' ${milestone==='true'?'checked':''}> Milestone</label><br>
                    <select name='subitem-type'>
                        <option value='internal' ${internal_external==='internal'?'selected':''}>Internal</option>
                        <option value='external' ${internal_external==='external'?'selected':''}>External</option>
                    </select><br>
                    <button type='submit'>Save</button>
                </form>`;
            }
            document.getElementById('modal-edit-content').innerHTML = formHtml;
            document.getElementById('modal-edit').style.display = 'flex';
        }
        function closeEditModal(event) {
            if(event.target.classList.contains('modal-edit') || event.target.classList.contains('modal-edit-close')) {
                document.getElementById('modal-edit').style.display = 'none';
                document.getElementById('modal-edit-content').innerHTML = '';
            }
        }
    </script>
</body>
</html>
