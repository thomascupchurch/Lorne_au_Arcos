<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <!-- FullCalendar assets -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <style>
    /* Gantt bar styling with opacity tiers for hierarchy containment (phase > item > subitem) */
    /* Uniform bar styling (reverted original thickness) */
    .gantt .bar { stroke-width:1; height:20px; rx:3; ry:3; }
    .gantt .bar.subitem-bar, .gantt .bar.item-bar, .gantt .bar.phase-bar { height:20px; }
    /* Hide default per-task grid rows (we will supply 3 category lanes) */
    .gantt .grid .row:not(:first-child) { display:none; }
    .gantt .grid .row:first-child rect { height:120px !important; }
    /* Re-center thicker bars vertically inside wrapper */
    .gantt .bar-wrapper .bar { transform-origin: left center; }
    /* Internal (default) vs external colors; handle class on rect OR wrapper */
    .gantt .bar.phase-bar,
    .gantt .bar.item-bar,
    .gantt .bar.subitem-bar,
    .gantt .bar-wrapper.phase-bar .bar,
    .gantt .bar-wrapper.item-bar .bar,
    .gantt .bar-wrapper.subitem-bar .bar { fill:#FF8200 !important; stroke:#FF8200 !important; }
    .gantt .bar.external-bar,
    .gantt .bar-wrapper.external-bar .bar { fill:#4B4B4B !important; stroke:#4B4B4B !important; }
    /* Remove previous opacity tiers for clear color fidelity */
        .gantt .bar.critical-path { stroke:#d90000 !important; stroke-width:2 !important; filter:drop-shadow(0 0 4px rgba(217,0,0,0.5)); }
        /* Group band styling */
        .phase-group-band { fill:rgba(255,130,0,0.06); }
        body {
            margin: 0;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: #4B4B4B;
            padding-top:230px; /* reserve space for fixed branding header */
            box-sizing:border-box;
        }
    /* FullCalendar dark adjustments */
    .fc { --fc-border-color:#666; --fc-page-bg-color:#4B4B4B; --fc-neutral-bg-color:#555; --fc-neutral-text-color:#eee; }
    .fc .fc-toolbar-title { color:#fff; }
    .fc .fc-button { background:#333; border:1px solid #666; color:#eee; }
    .fc .fc-button:hover { background:#444; }
    .fc .fc-button-primary:not(:disabled).fc-button-active, .fc .fc-button-primary:focus { background:#555; border-color:#888; }
    .fc-theme-standard td, .fc-theme-standard th { border-color:#666; }
    /* Calendar date numbers - stronger contrast */
    .fc .fc-daygrid-day-number, .fc a.fc-daygrid-day-number { color:#d0d0d0 !important; font-weight:600; text-decoration:none; transition:color .15s ease; }
    .fc .fc-daygrid-day-number:hover { color:#ffffff !important; }
    /* Muted days outside current month */
    .fc .fc-daygrid-day.fc-day-other .fc-daygrid-day-number { color:#888 !important; }
    .fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-number { color:#222; background:#FFB366; border-radius:4px; padding:2px 4px; }
    .fc-daygrid-day.fc-day-today { background:rgba(255,130,0,0.18); }
    .fc .fc-col-header-cell-cushion { color:#f0f0f0; }
    .fc .fc-scrollgrid { border:1px solid #777; }
    .fc-event { background:#FF8200 !important; border:1px solid #d96c00 !important; color:#111 !important; font-weight:600; }
    .fc-event.fc-event-external { background:#4B4B4B !important; border:1px solid #2f2f2f !important; color:#fff !important; }
    .fc .fc-daygrid-event { padding:2px 4px; border-radius:6px; }
    .fc .fc-daygrid-block-event .fc-event-time { font-weight:500; }
    .fc .fc-daygrid-block-event .fc-event-title { font-weight:600; }
    .fc .fc-popover { background:#333; color:#eee; border:1px solid #666; }
    .fc .fc-popover .fc-popover-header { background:#444; }
        .container {
            display: flex;
            height: 100vh;
            gap: 0; /* handle provides its own spacing */
            max-width: 100vw;
            overflow: hidden; /* prevent page horizontal scroll */
        }
        .image-viewer {
            flex: 0 0 auto;
            background: #FF8200;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            border-radius: 24px;
            margin: 2em 0 2em 2em;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            padding: 1.25em 1.5em 1.5em;
            width: 380px;
            min-width: 260px;
            max-width: 720px;
            min-height: calc(100vh - 4em);
            max-height: calc(100vh - 4em);
            box-sizing: border-box;
        }
        .image-viewer h2 { margin: 0 0 0.75em 0; font-size: 1.3em; }
        .image-viewer form { width: 100%; margin-bottom: 0.75em; display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
        #image-viewer-thumbnails { flex:1 1 auto; width:100%; overflow-y:auto; padding:4px; display:flex; flex-wrap:wrap; gap:8px; align-content:flex-start; }
        #image-viewer-thumbnails::-webkit-scrollbar { width: 8px; }
        #image-viewer-thumbnails::-webkit-scrollbar-track { background: rgba(255,255,255,0.15); border-radius:8px; }
        #image-viewer-thumbnails::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.35); border-radius:8px; }
        .thumbnail { width:72px; height:72px; object-fit:cover; border:2px solid #fff; border-radius:10px; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.25); transition:transform .15s; }
        .thumbnail:hover { transform:scale(1.05); }
    /* Make full image container flex and fill remaining vertical space */
    #full-image-container { flex:1 1 auto; width:100%; margin-top:0.5em; background:rgba(0,0,0,0.15); border:2px dashed rgba(255,255,255,0.4); border-radius:16px; padding:10px; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:220px; box-sizing:border-box; overflow:hidden; }
        #full-image-container.empty { opacity:0.6; }
    #full-image { max-width:100%; max-height:100%; object-fit:contain; }
        #full-image-container button { margin-top:6px; background:#fff; color:#FF8200; border:none; padding:6px 14px; border-radius:20px; font-weight:600; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.25); }
        #full-image-container button:hover { background:#ffe0c2; }
        .planning-section {
            flex: 1 1 auto;
            background: #4B4B4B;
            color: #eee;
            min-width: 0; /* allow flexbox to shrink */
            display:flex;
            flex-direction:column;
            overflow:hidden;
        }
        .planning-scroll {
            flex:1 1 auto;
            overflow-y:auto;
            overflow-x:hidden;
            padding: 0 1.25em 2em 1.25em;
            box-sizing:border-box;
        }
        @media (max-width:1400px){
            #image-viewer-panel{ width:320px !important; }
        }
        @media (max-width:1100px){
            #image-viewer-panel{ display:none; }
            #viewer-resize-handle{ display:none; }
            .planning-section{ border-left: none; }
        }
        .resize-handle {
            flex: 0 0 10px;
            cursor: col-resize;
            position: relative;
            margin: 2em 0;
            width: 10px;
            background: linear-gradient(90deg, rgba(255,130,0,0.15), rgba(255,130,0,0.4), rgba(255,130,0,0.15));
            border-radius: 6px;
            transition: background .2s;
        }
        .resize-handle:before {
            content: '';
            position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            width: 4px; height: 40px; border-radius:2px;
            background: rgba(255,255,255,0.55);
            box-shadow: 0 0 0 1px rgba(0,0,0,0.15);
        }
        .resize-handle:hover { background: linear-gradient(90deg, rgba(255,130,0,0.35), rgba(255,130,0,0.65), rgba(255,130,0,0.35)); }
        .resizing * { user-select: none !important; cursor: col-resize !important; }
        /* ...existing code... */
        .modal-edit {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }
        .modal-edit-content {
            background: #fff;
            padding: 2em;
            border-radius: 16px;
            min-width: 300px;
            max-width: 90vw;
            box-shadow: 0 4px 24px rgba(0,0,0,0.18);
        }
        .modal-edit-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #222;
            font-size: 2em;
            cursor: pointer;
        }
    /* Planning section base (logos removed) */
    .planning-section { position:relative; }
    /* (Moved critical-path styling into pattern-based rule above) */
    .assoc-node.selected-node { outline:2px solid #FF8200; outline-offset:2px; border-radius:4px; }
    .planning-section .planning-scroll { position:relative; z-index:1; }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Planning App MVP</title>
    <link rel="stylesheet" href="https://unpkg.com/frappe-gantt@0.5.0/dist/frappe-gantt.css">
    <script src="https://unpkg.com/frappe-gantt@0.5.0/dist/frappe-gantt.min.js"></script>
    <!-- Removed conflicting light mode styles and .darkmode rules -->
</head>
<body>
    <!-- Removed old SVG texture patterns (abandoned texture approach) -->
    <header style="display:flex;justify-content:center;align-items:center;gap:0;padding:4px 0 2px 0;position:fixed;top:0;left:0;right:0;z-index:1000;background:#4B4B4B;">
    <img src="{{ url_for('static', filename='Power_T.svg') }}" alt="Power T" style="height:220px;width:auto;object-fit:contain;display:block;transform:translate(110px,-9px);">
        <div style="width:1px;height:90px;background:#888;margin:0 4px;align-self:center;box-shadow:0 0 0 1px rgba(255,255,255,0.05);"></div>
        <img src="{{ url_for('static', filename='LSI_Graphics.svg') }}" alt="LSI Graphics" style="height:110px;width:auto;object-fit:contain;display:block;margin-left:-2px;">
        {% if current_user.is_authenticated %}
                <div style="position:absolute;right:14px;bottom:10px;font:12px/1.2 'Segoe UI',sans-serif;color:#ddd;background:rgba(0,0,0,0.25);padding:6px 10px;border-radius:8px;backdrop-filter:blur(2px);display:flex;align-items:center;gap:10px;">
                        <div style="display:flex;flex-direction:column;gap:2px;">
                            <span style="opacity:0.9;font-weight:600;">You: {{ current_user.username }}</span>
                              <span style="font-size:11px;opacity:.85;">Active: <span id="active-user-chips">{% for u in active_usernames %}{% if u!=current_user.username %}<span class='active-chip' style='background:#555;color:#fff;padding:2px 6px;border-radius:12px;margin-right:4px;'>{{ u }}</span>{% endif %}{% endfor %}</span></span>
                        </div>
            {% if current_user.is_admin %}
            <a href="{{ url_for('main.admin_users') }}" style="color:#FF8200;background:#fff;padding:4px 8px;border-radius:6px;text-decoration:none;font-weight:600;">Admin</a>
            {% endif %}
            <a href="{{ url_for('main.change_password') }}" style="color:#fff;text-decoration:none;font-weight:600;">Password</a>
            <a href="{{ url_for('main.logout') }}" style="color:#FF8200;background:#fff;padding:4px 8px;border-radius:6px;text-decoration:none;font-weight:600;">Logout</a>
        </div>
        {% endif %}
    </header>
    <!-- Dark mode is now default -->
    <div class="container">
    <div class="image-viewer" id="image-viewer-panel">
            <h2>Image Viewer</h2>
            <form action="/upload" method="post" enctype="multipart/form-data">
                <input type="file" name="file" accept="image/png, image/jpeg, application/pdf">
                <select name="association-type" required>
                    <option value="">Associate With...</option>
                    <option value="phase">Phase</option>
                    <option value="item">Item</option>
                    <option value="subitem">Sub-Item</option>
                </select>
                <select name="association-id" required>
                    <option value="">Select...</option>
                    {% for phase in phases %}
                        <option value="phase-{{ phase.id }}">Phase: {{ phase.title }}</option>
                    {% endfor %}
                    {% for item in items %}
                        <option value="item-{{ item.id }}">Item: {{ item.title }}</option>
                    {% endfor %}
                    {% for subitem in subitems %}
                        <option value="subitem-{{ subitem.id }}">Sub-Item: {{ subitem.title }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Upload</button>
            </form>
            <div id="image-viewer-thumbnails" style="display:flex;flex-wrap:wrap;gap:8px;align-content:flex-start;"></div>
            <div id="full-image-container" class="empty">
                <div id="placeholder-text" style="text-align:center;font-size:0.9em;line-height:1.4; padding:0 6px;">Select a phase, item, or sub-item to load images.</div>
                <img id="full-image" src="" style="display:none;">
                <button id="close-full-image" style="display:none;" onclick="hideFullImage()">Close</button>
            </div>
            <script id="all-images-data" type="application/json">[{% for img in images %}{"id":{{ img.id }},"filename":"{{ img.filename }}","url":"{{ url_for('main.uploaded_file', filename=img.filename) }}","phase_id":{{ img.phase_id if img.phase_id else 'null' }},"item_id":{{ img.item_id if img.item_id else 'null' }},"subitem_id":{{ img.subitem_id if img.subitem_id else 'null' }} }{% if not loop.last %},{% endif %}{% endfor %}]</script>
        </div>
    <div id="viewer-resize-handle" class="resize-handle" role="separator" aria-orientation="vertical" aria-label="Resize image viewer" title="Drag to resize (double-click to reset)"></div>
                <div class="planning-section">
                    <div class="planning-scroll">
            <div style="margin-bottom:2em;display:flex;align-items:center;gap:1em;">
                <label for="project-select" style="font-weight:600;">Project:</label>
                <form id="project-select-form" method="post" action="/set_project" style="display:inline-block;">
                    <select name="project-id" id="project-select" style="min-width:180px;">
                        <option value="">Select Project</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.title }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Go</button>
                </form>
                <form id="project-form" action="/create_project" method="post" style="display:inline-block;">
                    <input type="text" name="project-title" placeholder="New Project Title" required style="min-width:160px;">
                    <button type="submit">Create New Project</button>
                </form>
            </div>
                        <h2>Planning Section</h2>
                        <h3 style="margin-top:1.5em;">Project Part Creation</h3>
                        <section id="holding-area" style="margin:10px 0 24px 0; border:1px solid #661a1a; padding:10px 12px; border-radius:10px; background:rgba(102,26,26,0.08);">
                            <h4 style="margin:0 0 8px 0;color:#ff7777;font-size:0.95em;display:flex;align-items:center;gap:8px;">Holding Area (Draft Parts) <span style="font-weight:400;font-size:0.8em;opacity:.8;">Title-only drafts appear here as red chips until promoted.</span></h4>
                            <form id="draft-create-form" style="display:flex;flex-wrap:wrap;gap:6px;align-items:flex-end;">
                                <div style="flex:3 1 220px;min-width:180px;">
                                    <label style="display:block;font-size:0.65em;opacity:.75;">Title *</label>
                                    <input type="text" name="draft-title" placeholder="Draft Title" required style="width:100%;">
                                </div>
                                <div style="flex:1 1 130px;min-width:110px;">
                                    <label style="display:block;font-size:0.65em;opacity:.75;">Type *</label>
                                    <select name="draft-type" required style="width:100%;">
                                        <option value="">—</option>
                                        <option value="phase">Phase</option>
                                        <option value="item">Item</option>
                                        <option value="subitem">SubItem</option>
                                    </select>
                                </div>
                                <div style="flex:1 1 130px;min-width:110px;">
                                    <label style="display:block;font-size:0.65em;opacity:.75;">Int/Ext</label>
                                    <select name="draft-internal-external" style="width:100%;">
                                        <option value="internal">Internal</option>
                                        <option value="external">External</option>
                                    </select>
                                </div>
                                <div style="flex:0 0 auto;">
                                    <button type="submit" style="background:#aa0000;color:#fff;border:none;padding:0.55em 1em;border-radius:8px;font-weight:600;cursor:pointer;">Add Draft</button>
                                </div>
                            </form>
                            <div id="draft-bars" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;"></div>
                        </section>
            <div id="planning-view-controls" style="display:flex;gap:1em;align-items:center;margin-bottom:1em;">
                <button onclick="showView('gantt')" id="btn-gantt">Gantt Chart</button>
                <button onclick="showView('calendar')" id="btn-calendar">Calendar</button>
                <button onclick="showView('timeline')" id="btn-timeline">Timeline</button>
                {% if current_user.is_admin %}
                <a href="/admin/users" style="margin-left:auto;background:#FF8200;color:#fff;padding:0.4em 0.8em;border-radius:6px;text-decoration:none;font-size:0.85em;">User Admin</a>
                {% endif %}
            </div>
            <div id="planning-view" style="margin-bottom:2em;">
                <div id="gantt-view" style="display:block;">
                                        <div style="display:flex;align-items:center;gap:1em;flex-wrap:wrap;">
                                            <h3 style="margin:0;">Gantt Chart</h3>
                                              <div id="critical-legend" style="display:flex;align-items:center;gap:12px;background:#fff;border:1px solid #ccc;padding:6px 10px;border-radius:10px;font-size:11px;">
                                                <span style="display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FF8200;border-radius:3px;display:inline-block;border:1px solid #d96c00;"></span>Internal</span>
                                                <span style="display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#4B4B4B;border-radius:3px;display:inline-block;border:1px solid #2f2f2f;"></span>External</span>
                                                <span style="display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:linear-gradient(135deg,#FF8200 40%,#d90000 40%);border-radius:3px;display:inline-block;border:1px solid #d90000;box-shadow:0 0 4px rgba(217,0,0,0.5);"></span>Critical</span>
                                                <div style="margin-left:8px;display:flex;gap:6px;">
                                                    <button type="button" id="btn-critical-only" style="background:#d90000;color:#fff;border:none;padding:4px 10px;border-radius:6px;font-weight:600;cursor:pointer;font-size:11px;">Show Critical Only</button>
                                                    <button type="button" id="btn-critical-all" style="background:#666;color:#fff;border:none;padding:4px 10px;border-radius:6px;font-weight:600;cursor:pointer;font-size:11px;display:none;">Show All</button>
                                                  <a id="btn-critical-export" href="/export_critical_csv" style="background:#FF8200;color:#fff;padding:4px 10px;border-radius:6px;font-weight:600;font-size:11px;text-decoration:none;">Export CSV</a>
                                                </div>
                                            </div>
                                        </div>
                    <div id="gantt-chart" style="height:400px; border:1px solid #888; background:#fff; border-radius:16px; position:relative;"></div>
                    <div id="critical-path-container" style="margin-top:0.5em; font-size:0.8em; background:#fff; padding:0.6em 0.8em; border-radius:10px; border:1px solid #ccc;">
                              <strong>Critical Path:</strong> <span id="critical-path-list" style="color:#d90000;">(calculating...)</span>
                              <div id="critical-badge-legend" style="margin-top:4px;font-size:0.7em;color:#444;">
                                  <em>Order badges</em> appear next to phases/items on the path.
                              </div>
                    </div>
                    <!-- Reusable Edit Modal -->
                    <div id="unified-edit-modal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:3000;align-items:center;justify-content:center;">
                        <div style="background:#fff;color:#222;min-width:320px;max-width:520px;padding:1em 1.2em;border-radius:14px;position:relative;box-shadow:0 6px 28px rgba(0,0,0,0.3);">
                            <button type="button" id="unified-edit-close" style="position:absolute;right:8px;top:6px;background:transparent;border:none;font-size:1.4em;cursor:pointer;">×</button>
                            <h3 id="unified-edit-title" style="margin:0 0 .75em 0;font-size:1.1em;">Edit</h3>
                            <form id="unified-edit-form" method="post" style="display:flex;flex-direction:column;gap:.55em;">
                                <input type="hidden" name="edit-kind" value="">
                                <input type="hidden" name="edit-id" value="">
                                <label style="font-size:.75em;opacity:.7;">Title <input type="text" name="edit-title" required style="width:100%;"></label>
                                <div style="display:flex;gap:.6em;">
                                    <label style="flex:1;font-size:.75em;opacity:.7;">Start <input type="date" name="edit-start" required style="width:100%;"></label>
                                    <label style="width:110px;font-size:.75em;opacity:.7;">Duration <input type="number" name="edit-duration" min="1" required style="width:100%;"></label>
                                </div>
                                <div style="display:flex;gap:.6em;align-items:center;flex-wrap:wrap;">
                                    <label style="font-size:.7em;opacity:.8;display:flex;align-items:center;gap:4px;">Milestone <input type="checkbox" name="edit-milestone"></label>
                                    <label style="font-size:.7em;opacity:.8;">Type
                                        <select name="edit-internal-external" style="margin-left:4px;">
                                            <option value="internal">Internal</option>
                                            <option value="external">External</option>
                                        </select>
                                    </label>
                                    <label style="flex:1;font-size:.7em;opacity:.8;">Dependencies
                                        <input type="text" name="edit-dependencies" placeholder="IDs" style="width:100%;">
                                    </label>
                                </div>
                                <label style="font-size:.7em;opacity:.8;">Notes
                                    <textarea name="edit-notes" style="width:100%;min-height:60px;resize:vertical;"></textarea>
                                </label>
                                <div style="display:flex;gap:.5em;justify-content:flex-end;margin-top:.4em;">
                                    <button type="button" id="unified-edit-cancel" style="background:#666;color:#fff;border:none;padding:.5em 1em;border-radius:6px;cursor:pointer;">Cancel</button>
                                    <button type="submit" style="background:#FF8200;color:#fff;border:none;padding:.55em 1.2em;border-radius:6px;font-weight:600;cursor:pointer;">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div id="calendar-view" style="display:none;">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <h3 style="margin:0;">Calendar</h3>
                        <a href="/export_calendar_ics" style="background:#FF8200;color:#fff;padding:0.5em 1em;border-radius:8px;text-decoration:none;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:background 0.2s;" onmouseover="this.style.background='#e46e00'" onmouseout="this.style.background='#FF8200'">Export to Outlook</a>
                    </div>
                    <div id="calendar-chart" style="height:400px; border:1px solid #888; background:#fff; border-radius:16px;"></div>
                </div>
                <div id="timeline-view" style="display:none;">
                    <h3>Timeline</h3>
                    <div id="timeline-chart" style="height:400px; border:1px solid #888; background:#fff; border-radius:16px; overflow:auto; padding:1em; font:14px/1.4 'Segoe UI', Arial, sans-serif;">
                        <p style="margin-top:0;color:#555;">Chronological view of phases and items.</p>
                        <ul id="timeline-list" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:row;align-items:flex-start;gap:1.5em;">
                        </ul>
                    </div>
                </div>
            </div>
            <div id="planning-ui" style="background:rgba(255,255,255,0.03);border-radius:16px;padding:1em;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:1em;">
                <form id="unified-part-form" action="/create_part" method="post" style="display:flex;flex-wrap:wrap;gap:0.75em;align-items:flex-end;">
                    <div style="flex:1 1 160px;min-width:160px;">
                        <label style="display:block;font-size:0.7em;opacity:0.8;">Type</label>
                        <select name="part-type" id="part-type" required style="width:100%;">
                            <option value="phase">Phase</option>
                            <option value="item">Item</option>
                            <option value="subitem">Sub-Item</option>
                        </select>
                    </div>
                    <div style="flex:2 1 220px;min-width:200px;">
                        <label style="display:block;font-size:0.7em;opacity:0.8;">Title</label>
                        <input type="text" name="part-title" placeholder="Title" required style="width:100%;">
                    </div>
                    <div style="flex:1 1 140px;min-width:120px;">
                        <label style="display:block;font-size:0.7em;opacity:0.8;">Start</label>
                        <input type="date" name="part-start" required style="width:100%;">
                    </div>
                    <div style="flex:0 0 110px;">
                        <label style="display:block;font-size:0.7em;opacity:0.8;">Duration (d)</label>
                        <input type="number" name="part-duration" placeholder="Days" min="1" required style="width:100%;">
                    </div>
                    <div style="flex:0 0 120px;">
                        <label style="display:block;font-size:0.7em;opacity:0.8;">Internal/Ext</label>
                        <select name="part-internal-external" style="width:100%;">
                            <option value="internal">Internal</option>
                            <option value="external">External</option>
                        </select>
                    </div>
                    <div id="project-select-wrapper" style="flex:1 1 160px;min-width:150px;">
                        <label style="display:block;font-size:0.7em;opacity:0.8;">Project (for Phase)</label>
                        <select name="project-id" id="unified-project-id" style="width:100%;">
                            <option value="">Project</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="phase-select-wrapper" style="flex:1 1 160px;min-width:150px;display:none;">
                        <label style="display:block;font-size:0.7em;opacity:0.8;">Phase (for Item)</label>
                        <select name="phase-id" id="unified-phase-id" style="width:100%;">
                            <option value="">Phase</option>
                            {% for phase in phases %}
                            <option value="{{ phase.id }}">{{ phase.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="item-select-wrapper" style="flex:1 1 160px;min-width:150px;display:none;">
                        <label style="display:block;font-size:0.7em;opacity:0.8;">Item (for Sub-Item)</label>
                        <select name="item-id" id="unified-item-id" style="width:100%;">
                            <option value="">Item</option>
                            {% for item in items %}
                            <option value="{{ item.id }}">{{ item.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex:1 1 200px;min-width:180px;">
                        <label style="display:block;font-size:0.7em;opacity:0.8;">Dependencies (IDs)</label>
                        <input type="text" name="part-dependencies" placeholder="e.g. item-3, subitem-5" style="width:100%;">
                    </div>
                    <div style="flex:0 0 90px;">
                        <label style="display:block;font-size:0.7em;opacity:0.8;">Milestone</label>
                        <input type="checkbox" name="part-milestone" style="transform:scale(1.2);margin-top:6px;">
                    </div>
                    <div style="flex:1 1 280px;min-width:240px;">
                        <label style="display:block;font-size:0.7em;opacity:0.8;">Notes</label>
                        <textarea name="part-notes" style="width:100%;min-height:44px;resize:vertical;"></textarea>
                    </div>
                    <div style="flex:0 0 120px;display:flex;gap:6px;">
                        <button type="submit" style="background:#FF8200;color:#fff;border:none;padding:0.6em 1em;border-radius:8px;font-weight:600;cursor:pointer;">Add</button>
                        <button type="reset" style="background:#555;color:#fff;border:none;padding:0.6em 1em;border-radius:8px;cursor:pointer;">Reset</button>
                    </div>
                </form>
                                <script>
                                                // Draft holding area script
                                                const draftData = (function(){
                                                    try { return JSON.parse((document.getElementById('draft-data')||{textContent:'[]'}).textContent || '[]'); }
                                                    catch(e){ return []; }
                                                })();
                                function renderDrafts(){
                                    const cont=document.getElementById('draft-bars'); if(!cont) return; cont.innerHTML='';
                                    draftData.forEach(d=>{
                                        const chip=document.createElement('div');
                                        chip.className='draft-chip';
                                        chip.dataset.id=d.id; chip.dataset.type=d.type;
                                        chip.style.cssText='background:#aa0000;color:#fff;padding:4px 10px;border-radius:18px;font-size:11px;font-weight:600;letter-spacing:.5px;display:inline-flex;align-items:center;gap:6px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.25);';
                                        chip.innerHTML='<span style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+d.title+'</span><span style="background:#fff;color:#aa0000;padding:2px 6px;border-radius:10px;font-size:10px;font-weight:700;">'+d.type+'</span>';
                                        chip.title='Click to promote';
                                        chip.addEventListener('click',()=> promptPromoteDraft(d));
                                        cont.appendChild(chip);
                                    });
                                }
                                document.addEventListener('DOMContentLoaded', renderDrafts);
                                const draftForm=document.getElementById('draft-create-form');
                                if(draftForm){ draftForm.addEventListener('submit', function(e){ e.preventDefault(); const fd=new FormData(draftForm); fetch('/create_draft_part',{method:'POST',body:fd}).then(r=>r.json()).then(resp=>{ if(resp.status==='ok'){ draftData.push(resp.draft); renderDrafts(); draftForm.reset(); } else { alert(resp.error||'Draft create failed'); } }); }); }
                                function promptPromoteDraft(d){
                                    // Minimal prompt-based promotion for now; will swap to nice modal later
                                    const start = prompt('Start date (YYYY-MM-DD) for '+d.title+':'); if(!start) return;
                                    const duration = prompt('Duration (days):', '1'); if(!duration) return;
                                    let attach='';
                                    if(d.type==='phase') { const pid=prompt('Project ID to attach Phase to:'); if(!pid) return; attach+='&project-id='+encodeURIComponent(pid); }
                                    if(d.type==='item') { const ph=prompt('Phase ID to attach Item to:'); if(!ph) return; attach+='&phase-id='+encodeURIComponent(ph); }
                                    if(d.type==='subitem') { const it=prompt('Item ID to attach SubItem to:'); if(!it) return; attach+='&item-id='+encodeURIComponent(it); }
                                    fetch('/promote_draft/'+d.id,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'start-date='+encodeURIComponent(start)+'&duration='+encodeURIComponent(duration)+attach})
                                                        .then(r=>r.json()).then(resp=>{
                                                            if(resp.status==='ok'){
                                                                 const idx=draftData.findIndex(x=>x.id===d.id); if(idx>-1){ draftData.splice(idx,1); renderDrafts(); }
                                                                 if(window._ganttTasks && resp.task){ window._ganttTasks.push(resp.task); const gc=document.getElementById('gantt-chart'); if(gc) gc.innerHTML=''; window._ganttInstance=new Gantt('#gantt-chart', window._ganttTasks,{ view_mode:'Day', bar_height:24, custom_popup_html:null, on_click:window._ganttClickHandler, on_date_change:window._ganttDateChangeHandler }); applyHierarchyVisuals(); enforceBarColors(); setTimeout(addLaneBands,0); }
                                                                 if(resp.hierarchy_snippet){
                                                                         insertPromotedSnippet(resp.part_type, resp.hierarchy_snippet, resp.parent_ids || {});
                                                                 }
                                                            } else { alert(resp.error||'Promotion failed'); }
                                                        });
                                }
                (function(){
                    const typeSel = document.getElementById('part-type');
                    const projWrap = document.getElementById('project-select-wrapper');
                    const phaseWrap = document.getElementById('phase-select-wrapper');
                    const itemWrap = document.getElementById('item-select-wrapper');
                    const form = document.getElementById('unified-part-form');
                    const depInput = form.querySelector('input[name="part-dependencies"]');
                    // Simple dependency suggestions store
                    window._dependencyIds = window._dependencyIds || [];
                    function updateVisibility(){
                        const v = typeSel.value;
                        projWrap.style.display = (v==='phase') ? 'block':'none';
                        phaseWrap.style.display = (v==='item') ? 'block':'none';
                        itemWrap.style.display = (v==='subitem') ? 'block':'none';
                    }
                    typeSel.addEventListener('change', updateVisibility);
                    updateVisibility();

                    function refreshDependencyPool(){
                        // collect ids from current gantt tasks
                        try {
                            const tasks = window._ganttTasks || [];
                            window._dependencyIds = tasks.map(t=> t.id);
                        } catch(e){}
                    }
                    refreshDependencyPool();

                    // Basic autocomplete dropdown
                    const dropdown = document.createElement('div');
                    dropdown.style.position='absolute';
                    dropdown.style.background='#222';
                    dropdown.style.border='1px solid #555';
                    dropdown.style.zIndex='3000';
                    dropdown.style.display='none';
                    dropdown.style.maxHeight='160px';
                    dropdown.style.overflowY='auto';
                    dropdown.style.fontSize='12px';
                    dropdown.style.minWidth='200px';
                    document.body.appendChild(dropdown);
                    function showDropdown(matches, anchor){
                        if(!matches.length){ dropdown.style.display='none'; return; }
                        dropdown.innerHTML='';
                        matches.slice(0,25).forEach(m=>{
                            const opt=document.createElement('div');
                            opt.textContent=m; opt.style.padding='4px 6px'; opt.style.cursor='pointer';
                            opt.onmouseover=()=> opt.style.background='#333';
                            opt.onmouseout=()=> opt.style.background='transparent';
                            opt.onclick=()=>{
                                const existing = depInput.value.trim();
                                if(existing){ depInput.value = existing.replace(/[,;]\s*$/,'') + ', ' + m; }
                                else { depInput.value = m; }
                                dropdown.style.display='none'; depInput.focus();
                            };
                            dropdown.appendChild(opt);
                        });
                        const rect = anchor.getBoundingClientRect();
                        dropdown.style.left = rect.left + window.scrollX + 'px';
                        dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
                        dropdown.style.display='block';
                    }
                    depInput.addEventListener('input', function(){
                        const val = this.value.split(/[,;]/).pop().trim().toLowerCase();
                        if(!val){ dropdown.style.display='none'; return; }
                        const matches = (window._dependencyIds||[]).filter(id=> id.toLowerCase().includes(val));
                        showDropdown(matches, this);
                    });
                    document.addEventListener('click', (e)=>{ if(!dropdown.contains(e.target) && e.target!==depInput) dropdown.style.display='none'; });

                    form.addEventListener('submit', function(ev){
                        ev.preventDefault();
                        const fd = new FormData(form);
                        fetch('/create_part', { method:'POST', body: fd, headers:{'Accept':'application/json','X-Requested-With':'XMLHttpRequest'} })
                        .then(r=> r.json().then(j=>({ok:r.ok,data:j})))
                        .then(resp=>{
                            if(!resp.ok){ alert(resp.data && resp.data.error ? resp.data.error : 'Create failed'); return; }
                            const t = resp.data.task;
                            if(!t){ return; }
                            // Update internal tasks list
                            if(!Array.isArray(window._ganttTasks)) window._ganttTasks=[];
                            window._ganttTasks.push(t);
                            // Re-render gantt quickly
                            const gc=document.getElementById('gantt-chart'); if(gc) gc.innerHTML='';
                            window._ganttInstance = new Gantt('#gantt-chart', window._ganttTasks, { view_mode:'Day', bar_height:24, custom_popup_html:null, on_click:window._ganttClickHandler, on_date_change:window._ganttDateChangeHandler });
                            applyHierarchyVisuals(); enforceBarColors(); setTimeout(addLaneBands,0);
                            // Update critical path display
                            if(resp.data.critical_path){
                                document.querySelectorAll('.gantt .bar.critical-path').forEach(b=> b.classList.remove('critical-path'));
                                resp.data.critical_path.forEach(id=>{ const bar=document.querySelector(`.gantt .bar[data-id="${id}"]`); if(bar) bar.classList.add('critical-path'); });
                                const cpEl=document.getElementById('critical-path-list'); if(cpEl) cpEl.textContent=resp.data.critical_path.join(' → ');
                            }
                            // Insert hierarchy snippet
                            if(resp.data.hierarchy_snippet){
                                if(resp.data.part_type==='phase'){
                                    // append to each matching project block if project id matches
                                    const projId = resp.data.parent_ids && resp.data.parent_ids.project_id;
                                    if(projId){
                                        const projBlock = document.querySelector(`.project-block .assoc-node[data-type="project"][data-id="${projId}"]`);
                                        if(projBlock){
                                            let childContainer = projBlock.parentElement.querySelector(':scope > .tree-children');
                                            if(childContainer){ childContainer.insertAdjacentHTML('beforeend', resp.data.hierarchy_snippet); }
                                        }
                                    }
                                } else if(resp.data.part_type==='item') {
                                    const phaseChildren = document.querySelector(`div.tree-children [data-type="phase"][data-id="${resp.data.parent_ids.phase_id}"]`);
                                    if(phaseChildren){
                                        // Need its sibling tree-children after phase node line
                                        const wrapper = phaseChildren.parentElement; // node-line container
                                        const tc = wrapper.nextElementSibling; // children container
                                        if(tc && tc.classList.contains('tree-children')) tc.insertAdjacentHTML('beforeend', resp.data.hierarchy_snippet);
                                    }
                                } else if(resp.data.part_type==='subitem') {
                                    const itemNode = document.querySelector(`div.tree-children [data-type="item"][data-id="${resp.data.parent_ids.item_id}"]`);
                                    if(itemNode){
                                        const wrapper = itemNode.parentElement;
                                        const tc = wrapper.nextElementSibling;
                                        if(tc && tc.classList.contains('tree-children')) tc.insertAdjacentHTML('beforeend', resp.data.hierarchy_snippet);
                                    }
                                }
                            }
                            // Update dependency pool and calendar
                            refreshDependencyPool();
                            if(window._calendarInstance){
                                try {
                                    const calEnd = new Date(t.end + 'T00:00:00Z'); calEnd.setDate(calEnd.getDate()+1);
                                    window._calendarInstance.addEvent({ id:t.id, title:t.name, start:t.start, end:calEnd.toISOString().slice(0,10), color: /external-bar/.test(t.custom_class)? '#4B4B4B':'#FF8200' });
                                } catch(e){}
                            }
                            form.reset();
                            typeSel.value='phase'; updateVisibility();
                        }).catch(()=> alert('Network error creating part'));
                    });
                })();
                </script>
                <div id="planning-hierarchy">
                    <h3>Project Hierarchy</h3>
                    <style>
                        .tree-toggle { cursor:pointer; font-weight:600; }
                        .tree-children { margin-left:1em; border-left:2px solid #666; padding-left:0.75em; }
                        .meta { color:#bbb; font-size:0.85em; }
                        .actions a, .actions button { font-size:0.75em; margin-left:0.5em; }
                        .inline-edit { background:rgba(255,255,255,0.05); padding:6px 8px; border-radius:8px; margin:4px 0 8px 18px; }
                        .inline-edit input[type=text], .inline-edit input[type=date], .inline-edit input[type=number], .inline-edit select { font-size:0.75em; padding:2px 4px; margin-right:4px; }
                        .inline-edit button { font-size:0.7em; margin-right:4px; }
                        .node-line button.small { font-size:0.65em; margin-left:6px; }
                        .node-line { display:inline-block; }
                    </style>
                    {% for project in projects %}
                    <div class="project-block" style="margin-bottom:0.75em;">
                        <div class="node-line assoc-node" data-type="project" data-id="{{ project.id }}">
                            <span class="tree-toggle" onclick="toggleNode(this)">[–]</span>
                            <strong>{{ project.title }}</strong>
                            <span class="meta">({{ project.phases|length }} phases)</span>
                            <span class="actions">
                                <a href="/export_project/{{ project.id }}">Export</a>
                                <form method="post" action="/delete_project/{{ project.id }}" style="display:inline;" onsubmit="return confirm('Delete project?');">
                                    <button type="submit" style="color:red;">Del</button>
                                </form>
                                <button type="button" class="small" onclick="toggleEdit('proj-edit-{{ project.id }}')">Edit</button>
                            </span>
                        </div>
                        <div id="proj-edit-{{ project.id }}" class="inline-edit" style="display:none;">
                            <form method="post" action="/edit_project/{{ project.id }}" style="display:flex;flex-wrap:wrap;align-items:center;gap:4px;">
                                <input type="text" name="project-title" value="{{ project.title }}" required>
                                <button type="submit">Save</button>
                                <button type="button" onclick="toggleEdit('proj-edit-{{ project.id }}')">Cancel</button>
                            </form>
                        </div>
                        <div class="tree-children">
                            {% for phase in project.phases %}
                            <div style="margin:4px 0;">
                                <div class="node-line assoc-node" data-type="phase" data-id="{{ phase.id }}">
                                    <span class="tree-toggle" onclick="toggleNode(this)">[–]</span>
                                    <strong>Phase:</strong> {{ phase.title }} <span class="meta">{{ phase.start_date }} / {{ phase.duration }}d</span>
                                                                        {% if phase.notes %}<span title="{{ phase.notes|e }}" style="color:#FF8200;font-size:0.75em;margin-left:6px;">📝</span>{% endif %}
                                    <span class="actions">
                                        <form method="post" action="/delete_phase/{{ phase.id }}" style="display:inline;" onsubmit="return confirm('Delete phase?');"><button type="submit" style="color:red;">Del</button></form>
                                        <button type="button" class="small" onclick="toggleEdit('phase-edit-{{ phase.id }}')">Edit</button>
                                    </span>
                                </div>
                                <div id="phase-edit-{{ phase.id }}" class="inline-edit" style="display:none;">
                                    <form method="post" action="/edit_phase/{{ phase.id }}" style="display:flex;flex-wrap:wrap;align-items:center;gap:4px;">
                                        <input type="text" name="phase-title" value="{{ phase.title }}" required>
                                        <input type="date" name="phase-start" value="{{ phase.start_date }}" required>
                                        <input type="number" name="phase-duration" value="{{ phase.duration }}" required style="width:70px;">
                                        <label style="font-size:0.65em;">M <input type="checkbox" name="phase-milestone" {% if phase.is_milestone %}checked{% endif %}></label>
                                        <select name="phase-type">
                                            <option value="internal" {% if phase.internal_external=='internal' %}selected{% endif %}>Int</option>
                                            <option value="external" {% if phase.internal_external=='external' %}selected{% endif %}>Ext</option>
                                        </select>
                                                                            <textarea name="phase-notes" placeholder="Notes" style="flex:1 1 100%;min-height:50px;">{{ phase.notes or '' }}</textarea>
                                        <button type="submit">Save</button>
                                        <button type="button" onclick="toggleEdit('phase-edit-{{ phase.id }}')">Cancel</button>
                                    </form>
                                </div>
                                <div class="tree-children">
                                    {% for item in phase.items %}
                                    <div style="margin:2px 0;">
                                        <div class="node-line assoc-node" data-type="item" data-id="{{ item.id }}">
                                            <span class="tree-toggle" onclick="toggleNode(this)">[–]</span>
                                            <strong>Item:</strong> {{ item.title }} <span class="meta">{{ item.start_date }} / {{ item.duration }}d</span>
                                                                                        {% if item.notes %}<span title="{{ item.notes|e }}" style="color:#FF8200;font-size:0.7em;margin-left:4px;">📝</span>{% endif %}
                                            <span class="actions">
                                                <form method="post" action="/delete_item/{{ item.id }}" style="display:inline;" onsubmit="return confirm('Delete item?');"><button type="submit" style="color:red;">Del</button></form>
                                                <button type="button" class="small" onclick="toggleEdit('item-edit-{{ item.id }}')">Edit</button>
                                            </span>
                                        </div>
                                        <div id="item-edit-{{ item.id }}" class="inline-edit" style="display:none;">
                                            <form method="post" action="/edit_item/{{ item.id }}" style="display:flex;flex-wrap:wrap;align-items:center;gap:4px;">
                                                <input type="text" name="item-title" value="{{ item.title }}" required>
                                                <input type="date" name="item-start" value="{{ item.start_date }}" required>
                                                <input type="number" name="item-duration" value="{{ item.duration }}" required style="width:70px;">
                                                <input type="text" name="item-dependencies" value="{{ item.dependencies or '' }}" placeholder="Deps" style="width:90px;">
                                                <label style="font-size:0.65em;">M <input type="checkbox" name="item-milestone" {% if item.is_milestone %}checked{% endif %}></label>
                                                <select name="item-type">
                                                    <option value="internal" {% if item.internal_external=='internal' %}selected{% endif %}>Int</option>
                                                    <option value="external" {% if item.internal_external=='external' %}selected{% endif %}>Ext</option>
                                                </select>
                                                                                            <textarea name="item-notes" placeholder="Notes" style="flex:1 1 100%;min-height:50px;">{{ item.notes or '' }}</textarea>
                                                <button type="submit">Save</button>
                                                <button type="button" onclick="toggleEdit('item-edit-{{ item.id }}')">Cancel</button>
                                            </form>
                                        </div>
                                        <div class="tree-children">
                                            {% for subitem in item.subitems %}
                                            <div style="margin:2px 0;">
                                                <div class="node-line assoc-node" data-type="subitem" data-id="{{ subitem.id }}">
                                                    <strong>Sub:</strong> {{ subitem.title }} <span class="meta">{{ subitem.start_date }} / {{ subitem.duration }}d</span>
                                                                                                        {% if subitem.notes %}<span title="{{ subitem.notes|e }}" style="color:#FF8200;font-size:0.65em;margin-left:4px;">📝</span>{% endif %}
                                                    <span class="actions">
                                                        <form method="post" action="/delete_subitem/{{ subitem.id }}" style="display:inline;" onsubmit="return confirm('Delete sub-item?');"><button type="submit" style="color:red;">Del</button></form>
                                                        <button type="button" class="small" onclick="toggleEdit('subitem-edit-{{ subitem.id }}')">Edit</button>
                                                    </span>
                                                </div>
                                                <div id="subitem-edit-{{ subitem.id }}" class="inline-edit" style="display:none;">
                                                    <form method="post" action="/edit_subitem/{{ subitem.id }}" style="display:flex;flex-wrap:wrap;align-items:center;gap:4px;">
                                                        <input type="text" name="subitem-title" value="{{ subitem.title }}" required>
                                                        <input type="date" name="subitem-start" value="{{ subitem.start_date }}" required>
                                                        <input type="number" name="subitem-duration" value="{{ subitem.duration }}" required style="width:70px;">
                                                        <input type="text" name="subitem-dependencies" value="{{ subitem.dependencies or '' }}" placeholder="Deps" style="width:90px;">
                                                        <label style="font-size:0.65em;">M <input type="checkbox" name="subitem-milestone" {% if subitem.is_milestone %}checked{% endif %}></label>
                                                        <select name="subitem-type">
                                                            <option value="internal" {% if subitem.internal_external=='internal' %}selected{% endif %}>Int</option>
                                                            <option value="external" {% if subitem.internal_external=='external' %}selected{% endif %}>Ext</option>
                                                        </select>
                                                                                                            <textarea name="subitem-notes" placeholder="Notes" style="flex:1 1 100%;min-height:50px;">{{ subitem.notes or '' }}</textarea>
                                                        <button type="submit">Save</button>
                                                        <button type="button" onclick="toggleEdit('subitem-edit-{{ subitem.id }}')">Cancel</button>
                                                    </form>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <script>
                    function toggleNode(el){
                        var next=el.parentElement.nextElementSibling; // expects the children container
                        if(!next) return;
                        if(next.style.display==='none'){ next.style.display='block'; el.textContent='[–]'; }
                        else { next.style.display='none'; el.textContent='[+]'; }
                    }
                    function toggleEdit(id){
                        var el = document.getElementById(id);
                        if(!el) return;
                        el.style.display = (el.style.display==='none'|| el.style.display==='') ? 'block':'none';
                    }
                </script>
                <!-- Hidden Gantt data for script parsing -->
                <script id="gantt-data" type="application/json">{{ gantt_json_js|safe }}</script>
                <script id="draft-data" type="application/json">{{ draft_json_js|safe if draft_json_js is defined else '[]' }}</script>
                <script id="cp-data" type="application/json">{{ critical_path_ids | tojson }}</script>
                <script id="calendar-events-data" type="application/json">{{ calendar_events_json|safe }}</script>
                <!-- Removed duplicate Gantt Chart container -->
<script>
function getGanttTasks() {
    try {
        return JSON.parse(document.getElementById('gantt-data').textContent);
    } catch (e) {
        console.error('Error parsing Gantt JSON:', e);
        return [];
    }
}
function renderGantt(){
    var tasks = getGanttTasks();
    if(!tasks || !tasks.length){
        document.getElementById('gantt-chart').innerHTML='<p style="text-align:center;line-height:400px;">No tasks to display</p>';
        var cpEl=document.getElementById('critical-path-list'); if(cpEl) cpEl.textContent='None';
        return;
    }
    // Preserve original full set for filtering
    window._allGanttTasks = tasks.slice();
    if(typeof Gantt !== 'function'){
        document.getElementById('gantt-chart').innerHTML='<p style="color:red;text-align:center;">Gantt library not loaded</p>';
        return;
    }
    // Backend already annotated critical path classes. Use provided list to show sequence.
    var cpProvided = (function(){ try { return JSON.parse(document.getElementById('cp-data').textContent)||[]; } catch(e){ return []; } })();
    var cpEl=document.getElementById('critical-path-list'); if(cpEl) cpEl.textContent = cpProvided.length? cpProvided.join(' → ') : 'None';
    // Global handlers stored for reuse after cascade re-renders
    window._ganttTasks = tasks;
    window._ganttClickHandler = function(task){
        try {
            if(!task || !task.id) return;
            let type = null; let rawId = null;
            if(task.id.startsWith('phase-')) { type='phase'; rawId=parseInt(task.id.replace('phase-','')); }
            else if(task.id.startsWith('item-')) { type='item'; rawId=parseInt(task.id.replace('item-','')); }
            else if(task.id.startsWith('subitem-')) { type='subitem'; rawId=parseInt(task.id.replace('subitem-','')); }
            if(type && !isNaN(rawId)) {
                document.querySelectorAll('.assoc-node.selected-node').forEach(n=> n.classList.remove('selected-node'));
                const node = document.querySelector(`.assoc-node[data-type="${type}"][data-id="${rawId}"]`);
                if(node) node.classList.add('selected-node');
                loadAssociatedThumbnails(type, rawId);
            }
        } catch(e){ console.error('Gantt click handler error', e); }
    };
    window._ganttDateChangeHandler = function(task,start,end){
        const s = start.toISOString().slice(0,10);
        const e = end.toISOString().slice(0,10);
        fetch('/update_gantt_task',{
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:task.id,start:s,end:e})
        }).then(r=> r.json().then(j=>({ok:r.ok,data:j}))).then(resp=>{
            if(!resp.ok){ alert('Error updating task'); return; }
            try {
                let nodeSel = null;
                if(task.id.startsWith('phase-')) nodeSel = `.assoc-node[data-type="phase"][data-id="${task.id.replace('phase-','')}"]`;
                else if(task.id.startsWith('item-')) nodeSel = `.assoc-node[data-type="item"][data-id="${task.id.replace('item-','')}"]`;
                else if(task.id.startsWith('subitem-')) nodeSel = `.assoc-node[data-type="subitem"][data-id="${task.id.replace('subitem-','')}"]`;
                if(nodeSel){ const node=document.querySelector(nodeSel); if(node){ const meta=node.querySelector('.meta'); if(meta){ meta.textContent = `${s} / ${resp.data.duration}d`; } } }
                if(window._calendarInstance){
                    const evt = window._calendarInstance.getEventById(task.id);
                    if(evt){ evt.setStart(s); const endObj=new Date(e); endObj.setDate(endObj.getDate()+1); evt.setEnd(endObj.toISOString().slice(0,10)); }
                }
                if(Array.isArray(window._ganttTasks)){
                    const tObj = window._ganttTasks.find(t=> t.id===task.id); if(tObj){ tObj.start=s; tObj.end=e; }
                }
                try { refreshTimeline(); } catch(err){}
                if(resp.data.critical_path){
                    document.querySelectorAll('.gantt .bar.critical-path').forEach(b=> b.classList.remove('critical-path'));
                    resp.data.critical_path.forEach(id=>{ const bar=document.querySelector(`.gantt .bar[data-id="${id}"]`); if(bar) bar.classList.add('critical-path'); });
                    const cpEl=document.getElementById('critical-path-list'); if(cpEl) cpEl.textContent=resp.data.critical_path.join(' → ');
                }
                applyHierarchyVisuals();
                if(resp.data.cascade && resp.data.cascade.length){
                    inPlaceCascadeApply(resp.data.cascade, resp.data.critical_path || []);
                }
            } catch(err){ console.error('Propagation error', err); }
        }).catch(()=> alert('Network error updating task'));
    };
    window._ganttInstance = new Gantt('#gantt-chart', tasks, { view_mode:'Day', bar_height:24, custom_popup_html:null, on_click:window._ganttClickHandler, on_date_change:window._ganttDateChangeHandler });
    applyHierarchyVisuals();
    enforceBarColors();
    setTimeout(addLaneBands, 0); // draw subtle category bands after initial render
}
document.addEventListener('DOMContentLoaded', function() { renderGantt(); });
/* Removed incomplete window.showView assignment to fix syntax error */
</script>
<script>
// Apply cascade adjustments in-place: update internal task list, recreate gantt instance
function inPlaceCascadeApply(adjustments, newCriticalPath){
    if(!Array.isArray(adjustments) || !adjustments.length) return;
    // Update internal task data
    adjustments.forEach(adj=>{
        if(!adj || !adj.id) return;
        const task = window._ganttTasks && window._ganttTasks.find(t=> t.id===adj.id);
        if(task){
            task.start = adj.start;
            // Derive end from start + duration
            try {
                const d = new Date(adj.start + 'T00:00:00Z');
                d.setDate(d.getDate() + (adj.duration||0));
                task.end = d.toISOString().slice(0,10);
            } catch(e){}
        }
        // Update hierarchy meta display
        let nodeSel=null;
        if(adj.id.startsWith('phase-')) nodeSel = `.assoc-node[data-type="phase"][data-id="${adj.id.replace('phase-','')}"]`;
        else if(adj.id.startsWith('item-')) nodeSel = `.assoc-node[data-type="item"][data-id="${adj.id.replace('item-','')}"]`;
        else if(adj.id.startsWith('subitem-')) nodeSel = `.assoc-node[data-type="subitem"][data-id="${adj.id.replace('subitem-','')}"]`;
        if(nodeSel){
            const node=document.querySelector(nodeSel);
            if(node){
                const meta=node.querySelector('.meta');
                if(meta){ meta.textContent = `${adj.start} / ${adj.duration}d`; }
            }
        }
        // Update calendar events
        if(window._calendarInstance){
            const evt = window._calendarInstance.getEventById(adj.id);
            if(evt){
                evt.setStart(adj.start);
                try {
                    const eDate = new Date(adj.start + 'T00:00:00Z');
                    eDate.setDate(eDate.getDate()+ (adj.duration||0));
                    eDate.setDate(eDate.getDate()+1); // exclusive end
                    evt.setEnd(eDate.toISOString().slice(0,10));
                } catch(e){}
            }
        }
    });
    // Re-render gantt to reposition bars
    const container = document.querySelector('#gantt-chart');
    if(container){ container.innerHTML=''; }
    window._ganttInstance = new Gantt('#gantt-chart', window._ganttTasks, {
        view_mode:'Day', bar_height:24, custom_popup_html:null,
        on_click: window._ganttClickHandler || function(){},
        on_date_change: window._ganttDateChangeHandler || function(){}
    });
    // Reapply visuals
    applyHierarchyVisuals(); enforceBarColors(); setTimeout(addLaneBands,0);
    if(newCriticalPath && newCriticalPath.length){
        document.querySelectorAll('.gantt .bar.critical-path').forEach(b=> b.classList.remove('critical-path'));
        newCriticalPath.forEach(id=>{
            const bar=document.querySelector(`.gantt .bar[data-id="${id}"]`); if(bar) bar.classList.add('critical-path');
        });
        const cpEl=document.getElementById('critical-path-list'); if(cpEl) cpEl.textContent=newCriticalPath.join(' → ');
    }
}
// Hierarchy insertion helpers
function insertHierarchySnippet(partType, snippet, parents){
    if(!snippet) return;
    if(partType==='phase'){
        const projectId = parents && parents.project_id;
        if(projectId){
            const projectNode = document.querySelector(`.project-block .assoc-node[data-type="project"][data-id="${projectId}"]`);
            if(projectNode){
                const treeChildren = projectNode.parentElement.querySelector(':scope > .tree-children');
                if(treeChildren){ treeChildren.insertAdjacentHTML('beforeend', snippet); }
            }
        }
    } else if(partType==='item'){
        const phaseId = parents && parents.phase_id;
        if(phaseId){
            const phaseNode = document.querySelector(`.assoc-node[data-type="phase"][data-id="${phaseId}"]`);
            if(phaseNode){
                // The next sibling .tree-children contains its items
                let sib = phaseNode.parentElement.nextElementSibling;
                if(sib && sib.classList.contains('tree-children')){ sib.insertAdjacentHTML('beforeend', snippet); }
            }
        }
    } else if(partType==='subitem'){
        const itemId = parents && parents.item_id;
        if(itemId){
            const itemNode = document.querySelector(`.assoc-node[data-type="item"][data-id="${itemId}"]`);
            if(itemNode){
                let sib = itemNode.parentElement.nextElementSibling;
                if(sib && sib.classList.contains('tree-children')){ sib.insertAdjacentHTML('beforeend', snippet); }
            }
        }
    }
}

// Insert promoted draft snippet (reuse existing logic with slight fallback)
function insertPromotedSnippet(partType, snippet, parents){
    if(!snippet) return;
    try { insertHierarchySnippet(partType, snippet, parents); return; } catch(e){}
    // Fallback: simple append to matching container
    if(partType==='phase'){
        const projId = parents && parents.project_id; if(projId){
            const projNode=document.querySelector(`.project-block .assoc-node[data-type="project"][data-id="${projId}"]`);
            if(projNode){ const tc=projNode.parentElement.querySelector(':scope > .tree-children'); if(tc) tc.insertAdjacentHTML('beforeend', snippet); }
        }
    } else if(partType==='item'){
        const phaseId = parents && parents.phase_id; if(phaseId){
            const phaseNode=document.querySelector(`.assoc-node[data-type="phase"][data-id="${phaseId}"]`);
            if(phaseNode){ const tc=phaseNode.parentElement.nextElementSibling; if(tc && tc.classList.contains('tree-children')) tc.insertAdjacentHTML('beforeend', snippet); }
        }
    } else if(partType==='subitem'){
        const itemId = parents && parents.item_id; if(itemId){
            const itemNode=document.querySelector(`.assoc-node[data-type="item"][data-id="${itemId}"]`);
            if(itemNode){ const tc=itemNode.parentElement.nextElementSibling; if(tc && tc.classList.contains('tree-children')) tc.insertAdjacentHTML('beforeend', snippet); }
        }
    }
}

// Edit modal reuse logic
function openEditModal(kind, id){
    const modal = document.getElementById('unified-edit-modal');
    if(!modal) return;
    const form = document.getElementById('unified-edit-form');
    form.reset();
    form.elements['edit-kind'].value = kind;
    form.elements['edit-id'].value = id;
    // Pre-fill from hierarchy meta (lightweight parse)
    let node = document.querySelector(`.assoc-node[data-type="${kind}"][data-id="${id}"]`);
    if(node){
        const meta = node.querySelector('.meta');
        const titleRaw = node.textContent || '';
        // Basic extraction: after 'Phase:' / 'Item:' / 'Sub:' prefix
        let title = titleRaw.replace(/^[^:]+:\s*/,'').trim();
        if(meta){
            // meta contains start / duration
            const parts = (meta.textContent||'').split('/');
            if(parts.length===2){
                form.elements['edit-start'].value = parts[0].trim();
                form.elements['edit-duration'].value = parts[1].trim().replace(/d$/,'');
            }
        }
        form.elements['edit-title'].value = title;
    }
    modal.style.display='flex';
}
function closeEditModal(){ const modal=document.getElementById('unified-edit-modal'); if(modal) modal.style.display='none'; }
document.addEventListener('click', function(e){
    if(e.target && e.target.matches('.actions button.small[data-edit-kind]')){
        const kind=e.target.getAttribute('data-edit-kind');
        const id=e.target.getAttribute('data-edit-id');
        openEditModal(kind,id);
    }
});
document.getElementById('unified-edit-close').onclick = closeEditModal;
document.getElementById('unified-edit-cancel').onclick = closeEditModal;
document.getElementById('unified-edit-form').addEventListener('submit', function(ev){
    ev.preventDefault();
    const kind = this.elements['edit-kind'].value;
    const id = this.elements['edit-id'].value;
    const payload = new FormData(this);
    // Map to existing endpoints
    let url=null;
    if(kind==='phase') url='/edit_phase/'+id; else if(kind==='item') url='/edit_item/'+id; else if(kind==='subitem') url='/edit_subitem/'+id;
    if(!url) return;
    fetch(url, {method:'POST', body:payload})
    .then(()=>{ window.location.reload(); })
    .catch(()=>{ alert('Edit failed'); });
});

// Dependency picker with labels
function buildDependencyPicker(){
    const depInput = document.querySelector('input[name="part-dependencies"]');
    if(!depInput) return; // unified form input
    const wrapper = document.createElement('div');
    wrapper.style.position='relative';
    depInput.parentElement.style.position='relative';
    const panel = document.createElement('div');
    panel.style.position='absolute'; panel.style.left='0'; panel.style.top='100%'; panel.style.zIndex='3100';
    panel.style.background='#222'; panel.style.border='1px solid #555'; panel.style.padding='4px'; panel.style.borderRadius='6px';
    panel.style.width='260px'; panel.style.maxHeight='220px'; panel.style.overflowY='auto'; panel.style.display='none';
    panel.id='dependency-picker-panel';
    depInput.parentElement.appendChild(panel);
    depInput.addEventListener('focus', ()=>{ refreshPanel(); panel.style.display='block'; });
    document.addEventListener('click', e=>{ if(!panel.contains(e.target) && e.target!==depInput) panel.style.display='none'; });
    function refreshPanel(){
        panel.innerHTML='';
        const tasks = window._ganttTasks || [];
        tasks.forEach(t=>{
            const btn=document.createElement('div');
            btn.textContent = `${t.id}  •  ${t.name}`; btn.style.padding='4px 6px'; btn.style.cursor='pointer'; btn.style.fontSize='11px'; btn.style.color='#eee';
            btn.onmouseover=()=> btn.style.background='#333'; btn.onmouseout=()=> btn.style.background='transparent';
            btn.onclick=()=>{
                const existing = depInput.value.trim();
                const addVal = t.id;
                if(existing){ depInput.value = existing.split(/[,;]\s*/).filter(Boolean).includes(addVal)? existing : existing + ', ' + addVal; }
                else { depInput.value = addVal; }
            };
            panel.appendChild(btn);
        });
    }
}
document.addEventListener('DOMContentLoaded', buildDependencyPicker);
function addLaneBands(){
                        const svg = document.querySelector('#gantt-chart svg');
                        if(!svg) return;
                        // Remove existing bands
                        svg.querySelectorAll('rect[data-cat-band]').forEach(r=>r.remove());
                        const wrappers = Array.from(svg.querySelectorAll('.bar-wrapper'));
                        if(!wrappers.length) return;
                        const catYs = { phase: [], item: [], subitem: [] };
                        wrappers.forEach(w=>{
                            const rect = w.querySelector('rect.bar'); if(!rect) return;
                            const classes = (w.getAttribute('class') + ' ' + rect.getAttribute('class'));
                            let cat='subitem';
                            if(/phase-bar/.test(classes)) cat='phase'; else if(/item-bar/.test(classes) && !/phase-bar/.test(classes)) cat='item';
                            const m = /translate\(([-0-9.]+),\s*([-0-9.]+)\)/.exec(w.getAttribute('transform')||'');
                            if(m) catYs[cat].push(parseFloat(m[2]));
                        });
                        const width = (svg.viewBox && svg.viewBox.baseVal)? svg.viewBox.baseVal.width : (svg.getAttribute('width')||1200);
                        const colors = { phase: 'rgba(255,130,0,0.05)', item: 'rgba(75,75,75,0.06)', subitem: 'rgba(0,0,0,0.04)' };
                        Object.keys(catYs).forEach(cat=>{
                            if(!catYs[cat].length) return;
                            catYs[cat].sort((a,b)=>a-b);
                            const minY = catYs[cat][0]-2;
                            const maxY = catYs[cat][catYs[cat].length-1] + 22; // approximate row area
                            const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
                            r.setAttribute('x','0'); r.setAttribute('y', String(minY));
                            r.setAttribute('width', width); r.setAttribute('height', String(maxY-minY));
                            r.setAttribute('fill', colors[cat]); r.setAttribute('data-cat-band', cat);
                            svg.insertBefore(r, svg.firstChild);
                        });
}
                                                (function(){
                                                    try {
                                                        var raw = document.getElementById('calendar-events-data');
                                                        if(raw){ calendarEvents = JSON.parse(raw.textContent || '[]'); }
                                                    } catch(e){ console.error('Calendar JSON parse error', e); calendarEvents=[]; }
                                                    calendarEvents = calendarEvents.map(function(e){
                                                        if(!e.id){
                                                            if(e.title && e.title.startsWith('Phase: ')) e.id = 'phase-' + e.title.replace('Phase: ','').replace(/\s+/g,'-');
                                                            else if(e.title && e.title.startsWith('Item: ')) e.id = 'item-' + e.title.replace('Item: ','').replace(/\s+/g,'-');
                                                            else if(e.title) e.id='evt-'+btoa(e.title).replace(/=/g,'');
                                                        }
                                                        return e;
                                                    });
                                                })();
                                                /* Removed laneLayout; using background bands only */
                                                    if(calendarEvents.length===0){
                                                        document.getElementById('calendar-chart').style.display='none';
                                                        var emptyMsg=document.getElementById('calendar-empty-message'); if(emptyMsg) emptyMsg.style.display='block';
                                                    } else {
                                                        window._calendarInstance.render();
                                                    }
                                                    document.getElementById('saveEventBtn').onclick = function(){
                                                        var event=window.currentCalendarEvent;
                                                        var newTitle=document.getElementById('eventTitle').value;
                                                        var newStart=document.getElementById('eventStart').value;
                                                        var newEnd=document.getElementById('eventEnd').value || newStart;
                                                        if(event){
                                                            event.setProp('title', newTitle); event.setStart(newStart); event.setEnd(newEnd);
                                                            fetch('/update_gantt_task',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:event.id,start:newStart,end:newEnd,title:newTitle})}).then(r=>{ if(!r.ok) alert('Update failed'); else $('#editEventModal').modal('hide'); });
                                                        } else {
                                                            var tempId = newTitle.startsWith('Phase: ')? 'phase-'+newTitle.replace('Phase: ','').replace(/\s+/g,'-') : newTitle.startsWith('Item: ')? 'item-'+newTitle.replace('Item: ','').replace(/\s+/g,'-') : 'evt-'+Date.now();
                                                            if(window._calendarInstance){ window._calendarInstance.addEvent({ id:tempId, title:newTitle, start:newStart, end:newEnd, color:newTitle.startsWith('Phase: ')? '#FF8200':'#4B4B4B'}); }
                                                            $('#editEventModal').modal('hide');
                                                        }
                                                        document.getElementById('eventId').value=''; window.currentCalendarEvent=null;
                                                    };
                                                </script>
            </div>
                    </div>
                </div>
    </div>
    <div id="image-modal" class="modal" onclick="closeModal(event)">
    <!-- Modal removed: images now display in viewer section -->
    <div id="modal-edit" class="modal-edit" onclick="closeEditModal(event)">
        <span class="modal-edit-close" onclick="closeEditModal(event)">&times;</span>
        <div class="modal-edit-content" id="modal-edit-content">
            <!-- Modal form will be injected here -->
        </div>
    </div>
    <script>
        function toggleDarkMode() {
            document.body.classList.toggle('darkmode');
        }
        function showView(view) {
            document.getElementById('gantt-view').style.display = 'none';
            document.getElementById('calendar-view').style.display = 'none';
            document.getElementById('timeline-view').style.display = 'none';
            if(view === 'gantt') document.getElementById('gantt-view').style.display = 'block';
            if(view === 'calendar') { document.getElementById('calendar-view').style.display = 'block'; initCalendar(); }
            if(view === 'timeline') { document.getElementById('timeline-view').style.display = 'block'; initTimeline(); }
        }
        function initCalendar(){
            if(window._calendarInstance) return; // already initialized
            const el = document.getElementById('calendar-chart');
            if(!el) return;
            let events=[];
            try { const raw=document.getElementById('calendar-events-data'); if(raw) events=JSON.parse(raw.textContent||'[]'); } catch(e) { console.error('Calendar data parse failed', e); }
            if(typeof FullCalendar === 'undefined'){ console.warn('FullCalendar not loaded'); return; }
            window._calendarInstance = new FullCalendar.Calendar(el, {
                initialView: 'dayGridMonth',
                height: 'auto',
                selectable: true,
                events: events,
                eventClick: function(info){
                    window.currentCalendarEvent = info.event;
                    // simple modal reuse if exists
                    const titleEl = document.getElementById('eventTitle');
                    const startEl = document.getElementById('eventStart');
                    const endEl = document.getElementById('eventEnd');
                    if(titleEl) titleEl.value = info.event.title;
                    if(startEl) startEl.value = info.event.startStr.slice(0,10);
                    if(endEl) endEl.value = (info.event.endStr||info.event.startStr).slice(0,10);
                    const idEl = document.getElementById('eventId'); if(idEl) idEl.value = info.event.id;
                    if(window.$){ $('#editEventModal').modal('show'); }
                }
            });
            window._calendarInstance.render();
        }
        // Image viewer logic
        function showFullImage(src) {
            const cont = document.getElementById('full-image-container');
            const img = document.getElementById('full-image');
            const ph = document.getElementById('placeholder-text');
            const closeBtn = document.getElementById('close-full-image');
            img.src = src;
            img.style.display = 'block';
            closeBtn.style.display = 'inline-block';
            if (ph) ph.style.display = 'none';
            cont.classList.remove('empty');
        }
        function hideFullImage() {
            const cont = document.getElementById('full-image-container');
            const img = document.getElementById('full-image');
            const ph = document.getElementById('placeholder-text');
            const closeBtn = document.getElementById('close-full-image');
            img.src = '';
            img.style.display = 'none';
            closeBtn.style.display = 'none';
            if (ph) ph.style.display = 'block';
            cont.classList.add('empty');
        }
        // --- Image viewer resize logic ---
    (function(){
            const panel = document.getElementById('image-viewer-panel');
            const handle = document.getElementById('viewer-resize-handle');
            if(!panel || !handle) return;
            let startX = 0; let startW = 0; let dragging = false;
            const MIN_W = 260; const MAX_W = 720; const DEFAULT_W = 380;
            function pxToNum(v){ return parseFloat(String(v).replace('px','')) || 0; }
            function onMouseMove(e){
                if(!dragging) return;
                const dx = e.clientX - startX;
                let w = Math.min(MAX_W, Math.max(MIN_W, startW + dx));
                panel.style.width = w + 'px';
            }
            function stop(){
                if(!dragging) return;
                dragging = false;
                document.documentElement.classList.remove('resizing');
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', stop);
            }
            handle.addEventListener('mousedown', e=>{
                startX = e.clientX;
                startW = panel.getBoundingClientRect().width;
                dragging = true;
                document.documentElement.classList.add('resizing');
                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('mouseup', stop);
                e.preventDefault();
            });
            handle.addEventListener('dblclick', ()=>{ panel.style.width = DEFAULT_W + 'px'; });
            // Touch support
            handle.addEventListener('touchstart', e=>{
                const t = e.touches[0];
                startX = t.clientX; startW = panel.getBoundingClientRect().width; dragging = true;
                document.documentElement.classList.add('resizing');
                window.addEventListener('touchmove', onTouchMove, {passive:false});
                window.addEventListener('touchend', stopTouch, {passive:false});
            }, {passive:false});
            function onTouchMove(e){
                if(!dragging) return; const t = e.touches[0];
                const dx = t.clientX - startX; let w = Math.min(MAX_W, Math.max(MIN_W, startW + dx));
                panel.style.width = w + 'px'; e.preventDefault();
            }
            function stopTouch(){ dragging=false; document.documentElement.classList.remove('resizing'); window.removeEventListener('touchmove', onTouchMove); window.removeEventListener('touchend', stopTouch); }
        })();
        // --- Dynamic Image Associations ---
        let ALL_IMAGES = [];
        let STRUCTURE = {phases:[],items:[],subitems:[]};
        (function(){
            try { ALL_IMAGES = JSON.parse(document.getElementById('all-images-data').textContent)||[]; } catch(e){ ALL_IMAGES=[]; }
            try { STRUCTURE = JSON.parse(document.getElementById('structure-data').textContent)||STRUCTURE; } catch(e){}
        })();
        function loadAssociatedThumbnails(type, id){
            const thumbWrap = document.getElementById('image-viewer-thumbnails');
            if(!thumbWrap) return;
            thumbWrap.innerHTML='';
            let filtered = [];
            if(type==='phase') filtered = ALL_IMAGES.filter(i=>i.phase_id===id);
            else if(type==='item') filtered = ALL_IMAGES.filter(i=>i.item_id===id);
            else if(type==='subitem') filtered = ALL_IMAGES.filter(i=>i.subitem_id===id);
            else if(type==='project') {
                const phaseIds = STRUCTURE.phases.filter(p=>p.project_id===id).map(p=>p.id);
                const itemIds = STRUCTURE.items.filter(it=> phaseIds.includes(it.phase_id)).map(it=>it.id);
                const subIds = STRUCTURE.subitems.filter(si=> itemIds.includes(si.item_id)).map(si=>si.id);
                filtered = ALL_IMAGES.filter(i=> (i.phase_id && phaseIds.includes(i.phase_id)) || (i.item_id && itemIds.includes(i.item_id)) || (i.subitem_id && subIds.includes(i.subitem_id)) );
            } else filtered = [];
            if(filtered.length===0){ hideFullImage(); const ph=document.getElementById('placeholder-text'); if(ph) ph.textContent='No images associated.'; return; }
            filtered.forEach(img=>{
                const div=document.createElement('div');
                div.style.cssText='display:inline-block;position:relative;';
                const el=document.createElement('img');
                el.src=img.url; el.title=img.filename; el.className='thumbnail';
                el.onclick=()=>showFullImage(img.url);
                div.appendChild(el);
                thumbWrap.appendChild(div);
            });
            showFullImage(filtered[0].url);
        }
        document.addEventListener('click', function(e){
            const nodeLine = e.target.closest('.assoc-node');
            if(!nodeLine) return;
            if(e.target.classList.contains('tree-toggle') || e.target.closest('.actions') || e.target.closest('form')) return; // ignore control clicks
            const type=nodeLine.getAttribute('data-type');
            const id=parseInt(nodeLine.getAttribute('data-id'));
            document.querySelectorAll('.assoc-node.selected-node').forEach(n=> n.classList.remove('selected-node'));
            nodeLine.classList.add('selected-node');
            if(['project','phase','item','subitem'].includes(type)) loadAssociatedThumbnails(type, id);
        });
        // --- Simple Timeline Initialization (client-side derived from gantt data) ---
        function initTimeline(){
            if(window._timelineInit) return; // run once
            var list = document.getElementById('timeline-list');
            if(!list) return;
            var tasks = [];
            try { tasks = getGanttTasks(); } catch(e){ tasks=[]; }
            if(!tasks || !tasks.length){
                list.innerHTML = '<li style="color:#999;">No timeline data.</li>';
                window._timelineInit = true; return;
            }
            // Normalize tasks -> only take phases & items for simplified timeline
            var filtered = tasks.filter(t=>/^(phase|item)/i.test(t.id));
            // Sort by start date
            filtered.sort(function(a,b){ return new Date(a.start) - new Date(b.start); });
            var minDate = new Date(filtered[0].start);
            var maxDate = filtered.reduce((mx,t)=>{ var d=new Date(t.end||t.start); return d>mx?d:mx; }, new Date(filtered[0].end||filtered[0].start));
            var rangeMs = maxDate - minDate || 1;
            filtered.forEach(function(t){
                var start = new Date(t.start);
                var end = new Date(t.end||t.start);
                var leftPct = ((start - minDate)/rangeMs)*100;
                var widthPct = Math.max(2, ((end - start)|| (24*60*60*1000))/rangeMs*100);
                var li = document.createElement('li');
                li.style.position='relative';
                li.style.flex='0 0 auto';
                li.style.width = Math.max(80, widthPct*5) + 'px';
                li.style.minWidth='80px';
                li.style.marginLeft = leftPct + '%';
                li.style.background = t.id.startsWith('phase')? '#FF8200' : '#4B4B4B';
                li.style.color = '#fff';
                li.style.padding='6px 8px';
                li.style.borderRadius='8px';
                li.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)';
                li.innerHTML = '<strong style="font-size:12px;">'+(t.name||t.id)+'</strong><br><span style="font-size:11px;opacity:.85;">'+t.start+' -> '+(t.end||t.start)+'</span>';
                list.appendChild(li);
            });
            window._timelineInit = true;
        }
        function refreshTimeline(){
            const list = document.getElementById('timeline-list');
            if(!list) return;
            list.innerHTML='';
            let tasks = [];
            try { tasks = getGanttTasks(); } catch(e){ tasks=[]; }
            if(!tasks.length){ list.innerHTML='<li style="color:#999;">No timeline data.</li>'; return; }
            var filtered = tasks.filter(t=>/^(phase|item)/i.test(t.id));
            // Re-read actual dates from hierarchy for accuracy
            filtered.forEach(t=>{
                const type = t.id.split('-')[0];
                const rawId = t.id.split('-')[1];
                const node = document.querySelector(`.assoc-node[data-type="${type}"][data-id="${rawId}"] .meta`);
                if(node){
                    const parts = node.textContent.split('/');
                    if(parts.length===2){
                        const start = parts[0].trim();
                        const dur = parseInt(parts[1]);
                        if(/\d{4}-\d{2}-\d{2}/.test(start) && !isNaN(dur)){
                            const d1 = new Date(start);
                            const d2 = new Date(d1.getTime()+dur*86400000);
                            t.start = start;
                            t.end = d2.toISOString().slice(0,10);
                        }
                    }
                    // Add grouping bands and indentation to labels
                    function applyHierarchyVisuals(){
                        const svg = document.querySelector('#gantt-chart svg');
                        if(!svg) return;
                        const barGroups = Array.from(svg.querySelectorAll('.bar-wrapper'));
                        // Map id -> wrapper
                        const wrappers = {};
                        barGroups.forEach(w=>{
                            const rect = w.querySelector('.bar');
                            if(rect){
                                const id = rect.getAttribute('data-id');
                                if(id) wrappers[id]=w;
                            }
                        });
                        // Insert group bands behind items belonging to each phase
                        const phaseIds = Object.keys(wrappers).filter(id=>id.startsWith('phase-'));
                        phaseIds.forEach(pid=>{
                            const phaseWrapper = wrappers[pid];
                            if(!phaseWrapper) return;
                            // find child items
                            const phaseNum = pid.replace('phase-','');
                            const itemIds = Object.keys(wrappers).filter(id=>id.startsWith('item-'))
                                .filter(iid=> {
                                    // match items whose original name contains Phase: title? (heuristic: rely on DOM ordering)
                                    return true; // fallback: we band from phase bar down until next phase
                                });
                            // Determine vertical span: from phase bar y to before next phase bar
                            const phaseRect = phaseWrapper.querySelector('rect.bar');
                            if(!phaseRect) return;
                            const y = parseFloat(phaseRect.getAttribute('y'));
                            // Find next phase y to cap
                            let nextY = null;
                            phaseIds.sort((a,b)=>{
                                const ra = wrappers[a].querySelector('rect.bar');
                                const rb = wrappers[b].querySelector('rect.bar');
                                return parseFloat(ra.getAttribute('y')) - parseFloat(rb.getAttribute('y'));
                            });
                            for(let i=0;i<phaseIds.length;i++){
                                if(phaseIds[i]===pid && i<phaseIds.length-1){
                                    const nr = wrappers[phaseIds[i+1]].querySelector('rect.bar');
                                    nextY = parseFloat(nr.getAttribute('y')); break;
                                }
                            }
                            const height = (nextY? nextY : (y+24+ (itemIds.length*24))) - y; // approximate
                            // draw band if not present
                            if(!svg.querySelector(`rect[data-band="${pid}"]`)){
                                const band = document.createElementNS('http://www.w3.org/2000/svg','rect');
                                band.setAttribute('x','0');
                                band.setAttribute('y', String(y));
                                band.setAttribute('width','100%');
                                band.setAttribute('height', String(height));
                                band.setAttribute('class','phase-group-band');
                                band.setAttribute('data-band', pid);
                                svg.insertBefore(band, svg.firstChild);
                            }
                        });
                        // Indent labels: text elements have class .bar-label usually sibling; adjust dx based on type
                        svg.querySelectorAll('.bar-group').forEach(g=>{
                            const rect = g.querySelector('.bar');
                            const text = g.querySelector('text');
                            if(rect && text){
                                if(rect.classList.contains('item-bar')){
                                    text.setAttribute('dx','12');
                                } else if(rect.classList.contains('subitem-bar')){
                                    text.setAttribute('dx','24');
                                } else {
                                    text.setAttribute('dx','4');
                                }
                            }
                        });
                    }
                }
            });
            filtered.sort(function(a,b){ return new Date(a.start) - new Date(b.start); });
            var minDate = new Date(filtered[0].start);
            var maxDate = filtered.reduce((mx,t)=>{ var d=new Date(t.end||t.start); return d>mx?d:mx; }, new Date(filtered[0].end||filtered[0].start));
            var rangeMs = maxDate - minDate || 1;
            filtered.forEach(function(t){
                var start = new Date(t.start);
                var end = new Date(t.end||t.start);
                var leftPct = ((start - minDate)/rangeMs)*100;
                var widthPct = Math.max(2, ((end - start)|| (24*60*60*1000))/rangeMs*100);
                var li = document.createElement('li');
                li.style.position='relative';
                li.style.flex='0 0 auto';
                li.style.width = Math.max(80, widthPct*5) + 'px';
                li.style.minWidth='80px';
                li.style.marginLeft = leftPct + '%';
                li.style.background = t.id.startsWith('phase')? '#FF8200' : '#4B4B4B';
                li.style.color = '#fff';
                li.style.padding='6px 8px';
                li.style.borderRadius='8px';
                li.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)';
                li.innerHTML = '<strong style="font-size:12px;">'+(t.name||t.id)+'</strong><br><span style="font-size:11px;opacity:.85;">'+t.start+' -> '+(t.end||t.start)+'</span>';
                list.appendChild(li);
            });
        }
        // Hierarchy visuals (bands + label indentation & existing opacity tiers)
        function applyHierarchyVisuals(){
            const svg = document.querySelector('#gantt-chart svg');
            if(!svg) return;
            const existingBands = svg.querySelectorAll('rect.phase-group-band');
            existingBands.forEach(b=>b.remove());
            const wrappers = {};
            svg.querySelectorAll('.bar-wrapper').forEach(w=>{
                const rect = w.querySelector('.bar');
                if(rect){ const id = rect.getAttribute('data-id'); if(id) wrappers[id]=w; }
            });
            const phaseIds = Object.keys(wrappers).filter(id=>id.startsWith('phase-')).sort((a,b)=>{
                const ya = parseFloat(wrappers[a].querySelector('.bar').getAttribute('y'));
                const yb = parseFloat(wrappers[b].querySelector('.bar').getAttribute('y'));
                return ya - yb;
            });
            phaseIds.forEach((pid, idx)=>{
                const phaseRect = wrappers[pid].querySelector('.bar');
                if(!phaseRect) return;
                const y = parseFloat(phaseRect.getAttribute('y'));
                let nextY = null;
                if(idx < phaseIds.length-1){
                    const nr = wrappers[phaseIds[idx+1]].querySelector('.bar');
                    if(nr) nextY = parseFloat(nr.getAttribute('y'));
                }
                // Determine approximate span: until next phase or +120px fallback
                const height = (nextY? (nextY - y) : 120);
                const band = document.createElementNS('http://www.w3.org/2000/svg','rect');
                band.setAttribute('x','0');
                band.setAttribute('y', String(y-2));
                const svgWidth = svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal.width : (svg.getAttribute('width')||1200);
                band.setAttribute('width', svgWidth);
                band.setAttribute('height', String(height+4));
                band.setAttribute('class','phase-group-band');
                band.setAttribute('data-band', pid);
                svg.insertBefore(band, svg.firstChild);
            });
            // Indent labels
            svg.querySelectorAll('.bar-group').forEach(g=>{
                const rect = g.querySelector('.bar');
                const text = g.querySelector('text');
                if(rect && text){
                    if(rect.classList.contains('item-bar')) text.setAttribute('dx','12');
                    else if(rect.classList.contains('subitem-bar')) text.setAttribute('dx','24');
                    else text.setAttribute('dx','4');
                }
            });
        }
        // Enforce bar colors if classes applied only to wrapper
    function enforceBarColors(){
            const svg = document.querySelector('#gantt-chart svg');
            if(!svg) return;
            svg.querySelectorAll('.bar-wrapper').forEach(w=>{
                const rect = w.querySelector('rect.bar');
                if(!rect) return;
                const cls = w.getAttribute('class') + ' ' + rect.getAttribute('class');
                if(/external-bar/.test(cls)){
                    rect.setAttribute('fill','#4B4B4B');
                    rect.setAttribute('stroke','#4B4B4B');
                } else {
                    rect.setAttribute('fill','#FF8200');
                    rect.setAttribute('stroke','#FF8200');
                }
            });
        }
                // --- Drag & Drop Hierarchy Ordering (basic) ---
                (function(){
                    const container=document.getElementById('planning-hierarchy'); if(!container) return;
                    let dragEl=null; let placeholder=document.createElement('div');
                    placeholder.style.height='6px'; placeholder.style.margin='2px 0'; placeholder.style.background='#FF8200'; placeholder.style.borderRadius='3px';
                    container.addEventListener('dragstart', e=>{
                        const node=e.target.closest('.node-line.assoc-node'); if(!node) return; dragEl=node; e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain', node.dataset.type+':'+node.dataset.id);
                        node.style.opacity='0.4';
                    });
                    container.addEventListener('dragend', e=>{ if(dragEl){ dragEl.style.opacity=''; dragEl=null; } placeholder.remove(); });
                    container.querySelectorAll('.node-line.assoc-node').forEach(n=> n.setAttribute('draggable','true'));
                    container.addEventListener('dragover', e=>{
                        if(!dragEl) return; const over=e.target.closest('.node-line.assoc-node'); if(!over || over===dragEl) return; e.preventDefault();
                        const rect=over.getBoundingClientRect(); const after=(e.clientY-rect.top) > rect.height/2; const parent=over.parentElement.parentElement; // wrapper -> tree-children
                        if(after) over.parentElement.after(placeholder); else over.parentElement.before(placeholder);
                    });
                    container.addEventListener('drop', e=>{
                        if(!dragEl || !placeholder.parentElement) return; e.preventDefault();
                        const wrapper=dragEl.parentElement; placeholder.replaceWith(wrapper);
                        // Determine new order & call backend
                        const type=dragEl.dataset.type; const id=dragEl.dataset.id; let siblings=[]; let parentId=null; let endpoint=null;
                        if(type==='phase'){
                            endpoint='/reorder_phase';
                            const projectBlock=dragEl.closest('.project-block'); parentId=projectBlock && projectBlock.querySelector('.assoc-node[data-type="project"]').dataset.id;
                            siblings=[...projectBlock.querySelectorAll('.node-line.assoc-node[data-type="phase"]')];
                        } else if(type==='item'){
                            endpoint='/reorder_item'; const phaseWrapper=findAncestorOfType(dragEl,'phase'); parentId=phaseWrapper? phaseWrapper.dataset.id:null; siblings=[...phaseWrapper.closest('[data-wrapper^="phase-"]').querySelectorAll('.node-line.assoc-node[data-type="item"]')];
                        } else if(type==='subitem'){
                            endpoint='/reorder_subitem'; const itemWrapper=findAncestorOfType(dragEl,'item'); parentId=itemWrapper? itemWrapper.dataset.id:null; siblings=[...itemWrapper.closest('[data-wrapper^="item-"]').querySelectorAll('.node-line.assoc-node[data-type="subitem"]')];
                        }
                        const newPos=siblings.findIndex(n=> n===dragEl);
                        if(endpoint && newPos>-1){
                            let payload={};
                            if(type==='phase') payload={phase_id:id, project_id:parentId, new_position:newPos};
                            if(type==='item') payload={item_id:id, phase_id:parentId, new_position:newPos};
                            if(type==='subitem') payload={subitem_id:id, item_id:parentId, new_position:newPos};
                            fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
                                .then(r=>r.json()).then(resp=>{ if(resp.status!=='ok') console.warn('Reorder failed', resp); });
                        }
                    });
                    function findAncestorOfType(node,type){
                        let cur=node;
                        while(cur){ if(cur.classList && cur.classList.contains('assoc-node') && cur.dataset.type===type) return cur; cur=cur.parentElement; }
                        return null;
                    }
                })();
                        // Active users polling
                        (function(){
                             const chipsEl = document.getElementById('active-user-chips');
                             if(!chipsEl) return;
                             function refreshActive(){
                                 fetch('/active_users').then(r=>r.json()).then(j=>{
                                     if(!Array.isArray(j.users)) return; const me='{{ current_user.username }}';
                                     chipsEl.innerHTML = j.users.filter(u=>u!==me).map(u=>`<span class='active-chip' style='background:#555;color:#fff;padding:2px 6px;border-radius:12px;margin-right:4px;'>${u}</span>`).join('');
                                 }).catch(()=>{});
                             }
                             setInterval(refreshActive, 20000);
                        })();
                        // --- Critical Path filtering & enhancements ---
                  (function(){
                      const btnOnly=document.getElementById('btn-critical-only');
                      const btnAll=document.getElementById('btn-critical-all');
                      if(!btnOnly||!btnAll) return;
                      function criticalIds(){
                         try { return (JSON.parse(document.getElementById('cp-data').textContent)||[]);} catch(e){ return []; }
                      }
                             function applyBadges(){
                                 const cp = criticalIds(); const orderMap={}; cp.forEach((id,i)=> orderMap[id]=i+1);
                                 document.querySelectorAll('.assoc-node .crit-badge').forEach(b=> b.remove());
                                 cp.forEach(id=>{
                                     let type=null; if(id.startsWith('phase-')) type='phase'; else if(id.startsWith('item-')) type='item'; else if(id.startsWith('subitem-')) type='subitem';
                                     if(!type) return; const rid=id.split('-')[1];
                                     const node=document.querySelector(`.assoc-node[data-type="${type}"][data-id="${rid}"]`);
                                     if(node){
                                         const badge=document.createElement('span');
                                         badge.className='crit-badge';
                                         badge.textContent=orderMap[id];
                                         badge.style.cssText='margin-left:6px;background:#d90000;color:#fff;font-size:10px;font-weight:700;min-width:18px;text-align:center;padding:2px 5px;border-radius:10px;box-shadow:0 0 4px rgba(217,0,0,0.4);transition:transform .25s, background .25s;';
                                         node.appendChild(badge);
                                     }
                                 });
                             }
                      function rebuild(tasks){
                         const gc=document.getElementById('gantt-chart'); if(gc) gc.innerHTML='';
                         window._ganttTasks = tasks.slice();
                         window._ganttInstance = new Gantt('#gantt-chart', window._ganttTasks, { view_mode:'Day', bar_height:24, custom_popup_html:null, on_click:window._ganttClickHandler, on_date_change:window._ganttDateChangeHandler });
                         applyHierarchyVisuals(); enforceBarColors(); setTimeout(addLaneBands,0);
                         // Dim hierarchy & calendar for non-critical when filtering
                         if(window._criticalFilterActive){
                             const cpSet = new Set(criticalIds());
                                        document.querySelectorAll('.assoc-node').forEach(n=>{
                                 const type=n.dataset.type; const id=n.dataset.id; if(['phase','item','subitem'].includes(type)){
                                                    const taskId=type+'-'+id; if(!cpSet.has(taskId)) n.style.opacity='0.15'; else n.style.opacity='1';
                                 }
                             });
                             if(window._calendarInstance){
                                             window._calendarInstance.getEvents().forEach(ev=>{ if(!cpSet.has(ev.id)) ev.setProp('display','auto'); });
                             }
                                        ghostNonCriticalBars();
                         } else {
                             document.querySelectorAll('.assoc-node').forEach(n=> n.style.opacity='');
                                        if(window._calendarInstance){ window._calendarInstance.getEvents().forEach(ev=> ev.setProp('display','auto')); }
                                        unghostBars();
                         }
                                 applyBadges();
                      }
                             function ghostNonCriticalBars(){
                                 const cpSet=new Set(criticalIds());
                                 const svg=document.querySelector('#gantt-chart svg'); if(!svg) return;
                                 svg.querySelectorAll('.bar-wrapper').forEach(w=>{
                                     const rect=w.querySelector('.bar'); if(!rect) return; const id=rect.getAttribute('data-id');
                                     if(!cpSet.has(id)){
                                         rect.style.fillOpacity='0.12'; rect.style.strokeOpacity='0.15';
                                     } else { rect.style.fillOpacity='1'; rect.style.strokeOpacity='1'; }
                                 });
                             }
                             function unghostBars(){
                                 const svg=document.querySelector('#gantt-chart svg'); if(!svg) return;
                                 svg.querySelectorAll('.bar-wrapper .bar').forEach(r=>{ r.style.fillOpacity='1'; r.style.strokeOpacity='1'; });
                             }
                      btnOnly.addEventListener('click', function(){
                         if(window._criticalFilterActive) return; window._criticalFilterActive=true;
                         const ids=new Set(criticalIds());
                         const filtered=(window._allGanttTasks||[]).filter(t=> ids.has(t.id));
                         rebuild(filtered);
                         btnOnly.style.display='none'; btnAll.style.display='inline-block';
                                 persistFilterState('on');
                      });
                      btnAll.addEventListener('click', function(){
                         window._criticalFilterActive=false; rebuild(window._allGanttTasks||[]);
                         btnAll.style.display='none'; btnOnly.style.display='inline-block';
                                 persistFilterState('off');
                      });
                      // If critical path updates externally, reapply filter
                      window._refreshCriticalFilter = function(){ if(window._criticalFilterActive){ const ids=new Set(criticalIds()); const filtered=(window._allGanttTasks||[]).filter(t=> ids.has(t.id)); rebuild(filtered);} };
                             function persistFilterState(state){ fetch('/set_critical_filter',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({state})}).catch(()=>{}); }
                             // Apply saved state on load
                               const saved = "{{ 'on' if critical_filter_active else 'off' }}";
                             if(saved==='on'){ setTimeout(()=>{ btnOnly.click(); }, 50); }
                             // Transition styling
                             const style=document.createElement('style'); style.textContent=`
                                 .assoc-node { transition: opacity .35s ease; }
                                 .gantt .bar { transition: fill-opacity .35s ease, stroke-opacity .35s ease; }
                                 .crit-badge:hover { transform: scale(1.15); background:#a80000 !important; }
                             `; document.head.appendChild(style);
                  })();
        // (No mutation observer for lane layout to avoid repeated upward shifts)
        function openEditModal(type, id, title, start, duration, milestone, internal_external, dependencies) {
            event.stopPropagation();
            let formHtml = '';
            if(type === 'project') {
                formHtml = `<form method='post' action='/edit_project/${id}'>
                    <h3>Edit Project</h3>
                    <input type='text' name='project-title' value='${title}' required><br>
                    <button type='submit'>Save</button>
                </form>`;
            } else if(type === 'phase') {
                formHtml = `<form method='post' action='/edit_phase/${id}'>
                    <h3>Edit Phase</h3>
                    <input type='text' name='phase-title' value='${title}' required><br>
                    <input type='date' name='phase-start' value='${start}' required><br>
                    <input type='number' name='phase-duration' value='${duration}' required><br>
                    <label><input type='checkbox' name='phase-milestone' ${milestone==='true'?'checked':''}> Milestone</label><br>
                    <select name='phase-type'>
                        <option value='internal' ${internal_external==='internal'?'selected':''}>Internal</option>
                        <option value='external' ${internal_external==='external'?'selected':''}>External</option>
                    </select><br>
                    <button type='submit'>Save</button>
                </form>`;
            } else if(type === 'item') {
                formHtml = `<form method='post' action='/edit_item/${id}'>
                    <h3>Edit Item</h3>
                    <input type='text' name='item-title' value='${title}' required><br>
                    <input type='date' name='item-start' value='${start}' required><br>
                    <input type='number' name='item-duration' value='${duration}' required><br>
                    <input type='text' name='item-dependencies' value='${dependencies||''}'><br>
                    <label><input type='checkbox' name='item-milestone' ${milestone==='true'?'checked':''}> Milestone</label><br>
                    <select name='item-type'>
                        <option value='internal' ${internal_external==='internal'?'selected':''}>Internal</option>
                        <option value='external' ${internal_external==='external'?'selected':''}>External</option>
                    </select><br>
                    <button type='submit'>Save</button>
                </form>`;
            } else if(type === 'subitem') {
                formHtml = `<form method='post' action='/edit_subitem/${id}'>
                    <h3>Edit Sub-Item</h3>
                    <input type='text' name='subitem-title' value='${title}' required><br>
                    <input type='date' name='subitem-start' value='${start}' required><br>
                    <input type='number' name='subitem-duration' value='${duration}' required><br>
                    <input type='text' name='subitem-dependencies' value='${dependencies||''}'><br>
                    <label><input type='checkbox' name='subitem-milestone' ${milestone==='true'?'checked':''}> Milestone</label><br>
                    <select name='subitem-type'>
                        <option value='internal' ${internal_external==='internal'?'selected':''}>Internal</option>
                        <option value='external' ${internal_external==='external'?'selected':''}>External</option>
                    </select><br>
                    <button type='submit'>Save</button>
                </form>`;
            }
            document.getElementById('modal-edit-content').innerHTML = formHtml;
            document.getElementById('modal-edit').style.display = 'flex';
    }
    function closeEditModal(event) {
            if(event.target.classList.contains('modal-edit') || event.target.classList.contains('modal-edit-close')) {
                document.getElementById('modal-edit').style.display = 'none';
                document.getElementById('modal-edit-content').innerHTML = '';
            }
        }
    </script>
</body>
</html>
